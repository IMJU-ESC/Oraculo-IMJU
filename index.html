<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oráculo Empático v4.0 - Dual Brain</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

    <style>
        /* --- ESTÉTICA BASE --- */
        :root { 
            --color-primary: #00f7ff; 
            --bg-grad: radial-gradient(circle at 50% 50%, #101030, #000);
        }
        body { 
            margin: 0; height: 100vh; overflow: hidden; 
            background: #000; 
            font-family: 'Courier New', sans-serif; 
            color: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: background 1s ease;
        }

        /* FONDO DINÁMICO */
        #aura-bg {
            position: fixed; inset: 0; 
            background: var(--bg-grad);
            z-index: -5; transition: opacity 2s ease; opacity: 0.8;
        }

        /* --- AVATAR --- */
        #avatar-wrapper {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 10;
        }

        .cabeza {
            position: relative; width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center;
        }

        /* OJOS */
        .ojos-container { display: flex; gap: 40px; z-index: 2; }
        .ojo {
            width: 90px; height: 120px; background: #fff;
            border-radius: 50%; position: relative; overflow: hidden;
            box-shadow: 0 0 40px rgba(255,255,255,0.3);
            transition: all 0.5s;
        }
        .pupila {
            width: 35px; height: 45px; background: #000;
            border-radius: 50%; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            transition: width 0.3s;
        }
        .parpado { position: absolute; width: 100%; background: #000; left: 0; transition: height 0.3s; z-index: 10; }
        .top { top: 0; height: 2%; } .bottom { bottom: 0; height: 2%; }

        /* CEJAS (NUEVO) */
        .cejas-container {
            position: absolute; top: 40px; width: 240px;
            display: flex; justify-content: space-between; z-index: 3;
        }
        .ceja {
            width: 90px; height: 12px; background: white; border-radius: 10px;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        /* BOCA (NUEVO) */
        .boca-container {
            position: absolute; bottom: 60px; width: 100%;
            display: flex; justify-content: center; z-index: 2;
        }
        .boca {
            width: 60px; height: 20px; 
            border: 4px solid white; border-color: transparent transparent white transparent;
            border-radius: 50%;
            transition: all 0.5s;
        }

        /* --- ESTADOS EMOCIONALES (Clases CSS que controlan todo) --- */
        
        /* 1. MISTICO (Neutro/Default) -> Azul/Violeta */
        .mistico { --bg-grad: radial-gradient(circle, #1a237e, #000); }
        .mistico .ceja { transform: translateY(0); }
        .mistico .boca { width: 50px; height: 10px; border-radius: 0; border-bottom: 4px solid white; } /* Linea recta */

        /* 2. CURIOSO (Preguntando) -> Verde/Turquesa */
        .curioso { --bg-grad: radial-gradient(circle, #00695c, #000); }
        .curioso .ceja.izq { transform: translateY(-15px) rotate(-10deg); }
        .curioso .ceja.der { transform: translateY(5px) rotate(5deg); }
        .curioso .boca { width: 40px; height: 20px; border-radius: 50%; border: 3px solid white; } /* Boca 'O' */

        /* 3. INTENSO (Analizando/Juzgando) -> Rojo/Naranja */
        .intenso { --bg-grad: radial-gradient(circle, #b71c1c, #000); }
        .intenso .ceja.izq { transform: translateY(10px) rotate(20deg); }
        .intenso .ceja.der { transform: translateY(10px) rotate(-20deg); }
        .intenso .ojo { height: 100px; } /* Ojos entrecerrados */
        .intenso .boca { border-radius: 0; width: 40px; transform: scaleY(-1); margin-bottom: 10px;} /* Boca triste/seria */

        /* 4. FELIZ (Resultado Bueno) -> Dorado */
        .feliz { --bg-grad: radial-gradient(circle, #ff6f00, #000); }
        .feliz .ceja { transform: translateY(-20px); }
        .feliz .boca { width: 80px; height: 40px; border-radius: 50%; border-color: transparent transparent white transparent; } /* Sonrisa */

        /* UI TEXTO */
        #dialogo {
            position: fixed; bottom: 25%; width: 80%; text-align: center;
            font-size: 20px; text-shadow: 0 2px 4px black; min-height: 50px;
        }
        
        /* BOTONES */
        #controles {
            position: fixed; bottom: 10%; display: flex; gap: 15px;
            opacity: 0; pointer-events: none; transition: 0.5s;
        }
        .activo { opacity: 1 !important; pointer-events: auto !important; }
        .btn {
            padding: 15px 30px; border: 1px solid white; background: rgba(0,0,0,0.7);
            color: white; border-radius: 30px; font-weight: bold; cursor: pointer;
        }
        .btn:hover { background: white; color: black; }

        /* FOTO RESULTADO */
        #resultado-foto {
            position: fixed; inset: 0; background: #050505; z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #foto-final { border: 10px solid white; transform: rotate(-2deg); box-shadow: 0 0 50px rgba(255,255,255,0.3); max-width: 80%; }
        #desc-final { margin-top: 20px; max-width: 80%; text-align: center; font-family: sans-serif; line-height: 1.4; color: #ccc;}

        /* CAMARA OCULTA */
        #webcam { position: fixed; opacity: 0; pointer-events: none; }

        /* INICIO */
        #inicio { position: fixed; inset: 0; background: black; z-index: 999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="mistico"> <video id="webcam" autoplay playsinline muted></video>
    <div id="aura-bg"></div>

    <div id="avatar-wrapper">
        <div class="cabeza">
            <div class="cejas-container">
                <div class="ceja izq"></div>
                <div class="ceja der"></div>
            </div>
            <div class="ojos-container">
                <div class="ojo"><div class="parpado top"></div><div class="pupila"></div><div class="parpado bottom"></div></div>
                <div class="ojo"><div class="parpado top"></div><div class="pupila"></div><div class="parpado bottom"></div></div>
            </div>
            <div class="boca-container">
                <div class="boca"></div>
            </div>
        </div>
    </div>

    <div id="dialogo"></div>

    <div id="controles">
        <button class="btn" onclick="gestionarRespuesta('SI')">SÍ</button>
        <button class="btn" onclick="gestionarRespuesta('NO')">NO</button>
        <button class="btn" onclick="gestionarRespuesta('QUIZÁS')">QUIZÁS</button>
    </div>

    <div id="resultado-foto">
        <img id="foto-final" src="">
        <h2 id="titulo-aura" style="color: white; margin-top: 15px;"></h2>
        <p id="desc-final"></p>
        <button class="btn" onclick="location.reload()" style="margin-top:20px">OTRA LECTURA</button>
    </div>

    <div id="inicio">
        <button class="btn" style="font-size: 24px; padding: 20px 50px;" onclick="iniciarExperiencia()">INICIAR LECTURA</button>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURACIÓN Y DATOS LOCALES
        // ==========================================
        const API_KEY = "AIzaSyBlJGQaWafqiSuituKURcRriR3t18YBnOs"; // <--- IMPORTANTE
        
        // BANCO DE PREGUNTAS (Respaldo Local Robustecido)
        // Cada pregunta afecta a un tipo de aura: [Fuego, Agua, Tierra, Aire]
        const bancoPreguntas = [
            { t: "¿Te guías más por el corazón que por la razón?", tipo: "agua" },
            { t: "¿Perdonas fácilmente una traición?", tipo: "tierra" },
            { t: "¿Te atrae el caos y la aventura?", tipo: "fuego" },
            { t: "¿Disfrutas mucho de tu soledad?", tipo: "aire" },
            { t: "¿Sientes las emociones de otros como tuyas?", tipo: "agua" },
            { t: "¿Prefieres planear todo antes de actuar?", tipo: "tierra" },
            { t: "¿Te enojas con facilidad?", tipo: "fuego" },
            { t: "¿Crees en el destino?", tipo: "aire" },
            { t: "¿Lloras con las películas?", tipo: "agua" },
            { t: "¿Eres líder natural en tu grupo?", tipo: "fuego" },
            { t: "¿Valoras la justicia sobre la piedad?", tipo: "aire" },
            { t: "¿Te cuesta aceptar los cambios?", tipo: "tierra" }
        ];

        // RESULTADOS DETALLADOS
        const perfilesAura = {
            fuego: { color: "#ff2a00", nombre: "AURA DE FUEGO", desc: "Tienes una energía imparable. Tu pasión mueve montañas, pero ten cuidado de no quemar a quienes te rodean. Eres líder, intenso y transformador." },
            agua:  { color: "#00b7ff", nombre: "AURA DE AGUA", desc: "Eres empatía pura. Fluyes con las emociones y tienes una intuición que asusta. Tu capacidad de sanar a otros es tu mayor don." },
            tierra: { color: "#4caf50", nombre: "AURA DE TIERRA", desc: "La estabilidad es tu esencia. Eres el pilar donde otros se apoyan. Práctico, leal y resistente, construyes realidades donde otros solo sueñan." },
            aire:   { color: "#e040fb", nombre: "AURA DE ETER", desc: "Vives en el mundo de las ideas. Tu mente es rápida y libre. No te atas a nada y ves conexiones que nadie más ve. Eres un visionario." }
        };

        // VARIABLES DE ESTADO
        let modoLocal = false; // Se activa si falla Gemini
        let preguntasSesion = [];
        let pasoActual = 0;
        let puntaje = { fuego: 0, agua: 0, tierra: 0, aire: 0 };
        let historialGemini = [];
        let modeloVision;

        // Elementos DOM
        const avatar = document.getElementById('avatar-wrapper');
        const bg = document.getElementById('aura-bg');
        const txt = document.getElementById('dialogo');
        const video = document.getElementById('webcam');

        // ==========================================
        // 2. INICIO Y MOTORES
        // ==========================================
        async function iniciarExperiencia() {
            document.getElementById('inicio').style.opacity = 0;
            setTimeout(()=>document.getElementById('inicio').remove(), 1000);

            // Iniciar Audio
            const ac = new (window.AudioContext || window.webkitAudioContext)();
            ac.resume();

            // Iniciar Cámara
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                video.play();
                
                // Iniciar IA Visual (Blazeface)
                modeloVision = await blazeface.load();
                loopVision(); // Ojos siguen al usuario
                
                // Selección de Preguntas para Modo Local (por si acaso)
                preguntasSesion = bancoPreguntas.sort(() => 0.5 - Math.random()).slice(0, 4);

                // PRIMER CONTACTO
                setEmocion('mistico');
                await hablar("Estoy sintonizando tu frecuencia energética...");
                setTimeout(() => primerPregunta(), 2000);

            } catch (e) {
                alert("Error de cámara: " + e.message);
            }
        }

        // ==========================================
        // 3. LÓGICA HÍBRIDA (IA + LOCAL)
        // ==========================================
        
        async function primerPregunta() {
            // Intentamos usar Gemini para el saludo inicial y pregunta 1
            const prompt = "Eres un oráculo místico. Saluda al usuario brevemente y hazle una pregunta filosófica de SÍ/NO para empezar a leer su aura.";
            const respuesta = await consultarGemini(prompt);
            
            if (respuesta) {
                // Éxito con Gemini
                setEmocion('curioso');
                await hablar(respuesta);
                mostrarBotones();
            } else {
                // Fallo -> Modo Local
                activarModoLocal();
            }
        }

        function gestionarRespuesta(respUser) {
            ocultarBotones();
            
            if (modoLocal) {
                // Lógica Local
                procesarRespuestaLocal(respUser);
            } else {
                // Lógica Gemini
                procesarRespuestaGemini(respUser);
            }
        }

        // --- RUTA GEMINI (PLAN A) ---
        async function consultarGemini(input) {
            setEmocion('intenso'); // Cara de pensar
            try {
                historialGemini.push({role: "user", parts: [{text: input}]});

                // Controller para timeout de 4 segundos
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 4000);

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: historialGemini,
                        generationConfig: { maxOutputTokens: 60 }
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!res.ok) throw new Error("Error API");
                const data = await res.json();
                const textoIA = data.candidates[0].content.parts[0].text;
                
                historialGemini.push({role: "model", parts: [{text: textoIA}]});
                return textoIA;
            } catch (e) {
                console.log("Fallo Gemini, cambiando a local...", e);
                return null; // Retorna null para activar fallback
            }
        }

        async function procesarRespuestaGemini(respUser) {
            pasoActual++;
            
            // Si ya hicimos 4 preguntas, vamos al final
            if (pasoActual >= 4) {
                finalizarExperiencia(true); // true = usar Gemini para veredicto
                return;
            }

            const prompt = `El usuario respondió ${respUser}. Haz otra pregunta psicológica corta y diferente (max 15 palabras) para juzgar su alma.`;
            const respuesta = await consultarGemini(prompt);

            if (respuesta) {
                setEmocion('curioso');
                await hablar(respuesta);
                mostrarBotones();
            } else {
                activarModoLocal(); // Si falla a mitad, cambiamos a local
            }
        }

        // --- RUTA LOCAL (PLAN B - FALLBACK) ---
        function activarModoLocal() {
            console.log("ACTIVANDO MODO LOCAL");
            modoLocal = true;
            // Si cambiamos a mitad, ajustamos el índice para seguir desde donde estabamos
            if (pasoActual >= 4) { finalizarExperiencia(false); return; }
            
            lanzarPreguntaLocal();
        }

        async function lanzarPreguntaLocal() {
            setEmocion('curioso');
            const preg = preguntasSesion[pasoActual];
            await hablar(preg.t);
            mostrarBotones();
        }

        function procesarRespuestaLocal(respUser) {
            // Calcular puntaje
            const tipoActual = preguntasSesion[pasoActual].tipo;
            if (respUser === 'SI') puntaje[tipoActual] += 2;
            if (respUser === 'QUIZÁS') puntaje[tipoActual] += 1;
            
            pasoActual++;

            if (pasoActual >= 4) {
                finalizarExperiencia(false);
            } else {
                lanzarPreguntaLocal();
            }
        }

        // ==========================================
        // 4. CONCLUSIÓN Y FOTO
        // ==========================================
        async function finalizarExperiencia(usarIA) {
            setEmocion('intenso');
            await hablar("He visto suficiente. Tu energía se revela ante mí...");
            
            setTimeout(async () => {
                let resultadoFinal;

                if (usarIA) {
                    // Pedir veredicto a Gemini
                    const veredicto = await consultarGemini("Dame el veredicto final del aura en formato JSON simple: { \"color\": \"#hex\", \"titulo\": \"NOMBRE\", \"desc\": \"Descripcion corta\" }");
                    try {
                        // Intentar limpiar el JSON (Gemini a veces pone ```json ... ```)
                        const jsonStr = veredicto.replace(/```json|```/g, '').trim();
                        resultadoFinal = JSON.parse(jsonStr);
                    } catch (e) {
                        // Si falla el parseo, calcular localmente
                        resultadoFinal = calcularGanadorLocal();
                    }
                } else {
                    resultadoFinal = calcularGanadorLocal();
                }

                // MOSTRAR RESULTADO
                setEmocion('feliz');
                // Cambiar fondo al color del aura
                document.body.style.background = resultadoFinal.color; 
                document.getElementById('aura-bg').style.background = `radial-gradient(circle, ${resultadoFinal.color}, #000)`;

                await hablar(`Tu aura es... ${resultadoFinal.titulo}`);
                tomarFoto(resultadoFinal);

            }, 2000);
        }

        function calcularGanadorLocal() {
            // Buscar el puntaje más alto
            let max = 0;
            let tipoGanador = 'fuego'; // default
            for (const [tipo, valor] of Object.entries(puntaje)) {
                if (valor > max) { max = valor; tipoGanador = tipo; }
            }
            // Retornar objeto completo del perfil
            return {
                color: perfilesAura[tipoGanador].color,
                titulo: perfilesAura[tipoGanador].nombre,
                desc: perfilesAura[tipoGanador].desc
            };
        }

        function tomarFoto(dataAura) {
            const canvas = document.createElement('canvas');
            canvas.width = 480; canvas.height = 640;
            const ctx = canvas.getContext('2d');

            // 1. Video (espejo)
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -480, 0, 480, 640);
            ctx.restore();

            // 2. Filtro Aura
            ctx.globalCompositeOperation = 'overlay';
            ctx.fillStyle = dataAura.color;
            ctx.fillRect(0,0,480,640);
            
            // 3. Marco suave
            ctx.globalCompositeOperation = 'destination-in';
            const grad = ctx.createRadialGradient(240,320, 200, 240,320, 400);
            grad.addColorStop(0, "white");
            grad.addColorStop(1, "transparent");
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,480,640);

            // Mostrar en pantalla
            document.getElementById('foto-final').src = canvas.toDataURL('image/png');
            document.getElementById('foto-final').style.borderColor = dataAura.color;
            document.getElementById('titulo-aura').innerText = dataAura.titulo;
            document.getElementById('titulo-aura').style.color = dataAura.color;
            document.getElementById('desc-final').innerText = dataAura.desc;
            
            document.getElementById('avatar-wrapper').style.display = 'none';
            document.getElementById('resultado-foto').style.display = 'flex';
        }

        // ==========================================
        // 5. ANIMACIONES Y UTILIDADES
        // ==========================================
        function setEmocion(emocion) {
            document.body.className = emocion; // Cambia variables CSS y posiciones
        }

        function mostrarBotones() { document.getElementById('controles').classList.add('activo'); }
        function ocultarBotones() { document.getElementById('controles').classList.remove('activo'); }

        function hablar(texto) {
            return new Promise(resolve => {
                txt.innerText = texto;
                const u = new SpeechSynthesisUtterance(texto);
                const voces = window.speechSynthesis.getVoices();
                const voz = voces.find(v => v.lang.includes('es'));
                if(voz) u.voice = voz;
                u.rate = 1.0;
                u.onend = resolve;
                window.speechSynthesis.speak(u);
            });
        }

        // Loop de Visión (Seguimiento de ojos)
        async function loopVision() {
            if (modeloVision) {
                const preds = await modeloVision.estimateFaces(video, false);
                if (preds.length > 0) {
                    const p = preds[0];
                    const x = (p.topLeft[0] + p.bottomRight[0]) / 2;
                    const y = (p.topLeft[1] + p.bottomRight[1]) / 2;
                    // Mover pupilas
                    const relX = 1 - (x / video.videoWidth); 
                    const relY = y / video.videoHeight;
                    document.querySelectorAll('.pupila').forEach(pup => {
                        pup.style.transform = `translate(calc(-50% + ${(relX-0.5)*40}px), calc(-50% + ${(relY-0.5)*30}px))`;
                    });
                }
            }
            requestAnimationFrame(loopVision);
        }

    </script>
</body>
</html>
