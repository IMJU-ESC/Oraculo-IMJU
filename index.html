<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Oráculo Social v65</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    <style>
        body { margin: 0; height: 100vh; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #webcam { position: fixed; opacity: 0; pointer-events: none; }
        #fondo-dinamico { position: fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, #1a237e, #000); z-index: 0; transition: background 2s; }
        #cabeza { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .ojos-container { display: flex; gap: 40px; }
        .ojo { width: 120px; height: 180px; background: white; border-radius: 50%; position: relative; box-shadow: 0 0 50px rgba(255,255,255,0.2); overflow: hidden; }
        .pupila { width: 40px; height: 50px; background: #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .boca { width: 40px; height: 5px; background: white; border-radius: 20px; margin-top: 30px; transition: 0.2s; }
        .hablando .boca { animation: hablar 0.2s infinite alternate; }
        @keyframes hablar { from { height: 5px; } to { height: 20px; } }
        #texto-principal { position: fixed; top: 15%; width: 80%; text-align: center; font-size: 2rem; font-weight: bold; text-shadow: 0 0 15px #000; z-index: 100; }
        #btn-init { padding: 20px 50px; font-size: 1.5rem; border: 2px solid #00e676; background: transparent; color: #00e676; border-radius: 50px; cursor: pointer; z-index: 10000; }
        #botones { position: fixed; bottom: 20%; display: none; gap: 20px; z-index: 1000; }
        .btn-opcion { padding: 15px 40px; font-size: 1.2rem; cursor: pointer; border-radius: 30px; border: 2px solid white; background: rgba(0,0,0,0.5); color: white; }
    </style>
</head>
<body>

    <div id="fondo-dinamico"></div>
    <video id="webcam" autoplay playsinline muted width="640" height="480"></video>
    <div id="texto-principal">CARGANDO...</div>
    
    <div id="inicio">
        <button id="btn-init" onclick="arrancar()" disabled>ESPERA...</button>
    </div>

    <div id="cabeza">
        <div class="ojos-container">
            <div class="ojo"><div class="pupila"></div></div>
            <div class="ojo"><div class="pupila"></div></div>
        </div>
        <div class="boca"></div>
    </div>

    <div id="botones">
        <button class="btn-opcion" onclick="respuestaBoton('si')">ACEPTO</button>
        <button class="btn-opcion" onclick="respuestaBoton('no')">NO</button>
    </div>

    <script>
        const API_KEY = "AIzaSyBlJGQaWafqiSuituKURcRriR3t18YBnOs";
        let modelo, video = document.getElementById('webcam'), estado = "CARGANDO";

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                modelo = await blazeface.load();
                document.getElementById('btn-init').disabled = false;
                document.getElementById('btn-init').innerText = "INICIAR";
                document.getElementById('texto-principal').innerText = "SISTEMA LISTO";
            } catch (e) { alert("Error cámara: " + e.message); }
        }

        function arrancar() {
            document.getElementById('inicio').style.display = 'none';
            estado = "BUSCANDO";
            loop();
        }

        async function loop() {
            const faces = await modelo.estimateFaces(video, false);
            if (faces.length > 0 && estado === "BUSCANDO") {
                const size = faces[0].bottomRight[0] - faces[0].topLeft[0];
                if (size > 50) { // Si te ve a una distancia normal
                    iniciar();
                }
            }
            requestAnimationFrame(loop);
        }

        async function iniciar() {
            estado = "CHARLANDO";
            let saludo = await pedirGemini("Salúdame de forma muy mística y pregúntame mi nombre.");
            hablar(saludo, () => {
                escuchar(nombre => {
                    pedirGemini(`Mi nombre es ${nombre}. Hazme un cumplido sobre mi energía e invítame a leer mi aura.`).then(invita => {
                        hablar(invita, () => {
                            document.getElementById('botones').style.display = 'flex';
                        });
                    });
                });
            });
        }

        async function pedirGemini(prompt) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { 
                console.error("Error API:", e);
                return "Siento una interferencia cósmica..."; 
            }
        }

        function hablar(txt, cb) {
            document.getElementById('texto-principal').innerText = txt;
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'es-MX';
            document.getElementById('cabeza').classList.add('hablando');
            u.onend = () => {
                document.getElementById('cabeza').classList.remove('hablando');
                if(cb) cb();
            };
            window.speechSynthesis.speak(u);
        }

        function escuchar(cb) {
            const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            rec.lang = 'es-MX';
            rec.start();
            document.getElementById('texto-principal').innerText = "TE ESCUCHO...";
            rec.onresult = (e) => cb(e.results[0][0].transcript);
        }

        function respuestaBoton(r) {
            document.getElementById('botones').style.display = 'none';
            if(r === 'si') {
                hablar("Excelente elección. Siento que tu aura es de color VIOLETA.");
            } else {
                hablar("Que la luz te guíe. Adiós.");
            }
        }

        init();
    </script>
</body>
</html>