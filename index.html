<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cupido IMJU Escuinapa - V17 Final</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Bangers&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILO GENERAL --- */
        :root { --imju-pink: #ff006e; --imju-purple: #8338ec; --imju-orange: #fb5607; }
        
        body {
            margin: 0; height: 100vh; overflow: hidden; font-family: 'Fredoka', sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #8338ec, #ff006e, #fb5607);
            background-size: 300% 300%;
            animation: fondoEscuinapa 15s ease infinite;
            color: white;
            user-select: none;
        }
        @keyframes fondoEscuinapa {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* FLASH */
        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 6000; pointer-events: none; opacity: 0; transition: opacity 0.1s;
        }
        .flash-active { opacity: 1 !important; }

        /* EMOJIS FONDO */
        .emoji-float {
            position: absolute; bottom: -50px; font-size: 2.5rem; opacity: 0.2;
            animation: subir 9s linear infinite; pointer-events: none; z-index: 0;
        }
        @keyframes subir {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; }
        }

        #webcam { position: fixed; top: 0; left: 0; visibility: hidden; pointer-events: none; }

        /* --- HEADER --- */
        #header-imju {
            position: fixed; top: 20px; text-align: center; z-index: 50;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.15);
        }
        #header-imju h1 { margin: 0; font-family: 'Bangers', cursive; font-size: 4rem; letter-spacing: 2px; color: white; }
        #header-imju p { margin: 0; font-size: 1.4rem; font-weight: bold; background: rgba(255,255,255,0.2); padding: 5px 20px; border-radius: 30px; display: inline-block; }

        /* --- AVATAR GIGANTE --- */
        #avatar-container { 
            position: relative; width: 550px; height: 450px;
            z-index: 10; margin-bottom: 10px; margin-top: 60px;
        }
        
        #cabeza {
            width: 100%; height: 100%; background: transparent; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; animation: flotar 5s ease-in-out infinite;
        }
        @keyframes flotar { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .faccion-sombra { filter: drop-shadow(0 8px 4px rgba(0,0,0,0.2)); }

        /* Cejas */
        .cejas-row { display: flex; gap: 140px; position: absolute; top: 30px; width: 100%; justify-content: center; transition: 0.4s; }
        .ceja { width: 110px; height: 28px; background: white; border-radius: 30px; transition: 0.3s; }

        /* Ojos */
        .ojos-row { display: flex; gap: 60px; margin-top: 60px; z-index: 2; }
        .ojo-wrapper {
            width: 150px; height: 150px; 
            position: relative; overflow: hidden; border-radius: 50%;
            background: white; border: 6px solid rgba(0,0,0,0.05); transition: 0.3s;
        }
        .pupila { 
            width: 70px; height: 70px; background: #222; border-radius: 50%; 
            position: absolute; top: 26%; left: 26%; transition: 0.1s;
        }
        .brillo {
            width: 30px; height: 30px; background: white; border-radius: 50%;
            position: absolute; top: 25px; right: 30px; opacity: 0.9;
        }
        .boca { 
            width: 80px; height: 25px; background: white; border-radius: 30px; 
            margin-top: 70px; transition: 0.3s; 
        }

        /* Expresiones */
        .hablando .boca { width: 100px; height: 70px; border-radius: 40% 40% 50% 50%; animation: hablarAnim 0.2s infinite alternate; }
        .hablando .ceja { animation: cejasHablando 0.5s infinite alternate; }
        @keyframes hablarAnim { from { height: 30px; transform: scaleY(0.8); } to { height: 70px; transform: scaleY(1); } }
        @keyframes cejasHablando { from { transform: translateY(0); } to { transform: translateY(-5px); } }

        .sospecha .ceja:first-child { transform: rotate(15deg) translateY(10px); }
        .sospecha .ceja:last-child { transform: rotate(-15deg) translateY(-20px); }
        .sospecha .ojo-wrapper { height: 120px; border-radius: 40%; margin-top: 15px; }
        .sospecha .boca { width: 60px; transform: translateX(10px) rotate(-5deg); }

        .sorpresa .ceja { transform: translateY(-50px) scaleX(1.1); }
        .sorpresa .ojo-wrapper { transform: scale(1.15); border-color: #ff006e; }
        .sorpresa .boca { width: 70px; height: 70px; border-radius: 50%; margin-top: 80px; }

        .feliz .ojo-wrapper { height: 80px; margin-top: 35px; border-radius: 10px 10px 100px 100px; }
        .feliz .boca { width: 110px; height: 50px; border-radius: 10px 10px 100px 100px; margin-top: 60px; }
        .feliz .ceja { transform: translateY(-10px); }

        .enamorado .ojo-wrapper { background: #ff006e; }
        .enamorado .pupila, .enamorado .brillo { opacity: 0; }
        .enamorado .ojo-wrapper::after { content:'üòç'; font-size:100px; position:absolute; top:20px; left:25px; animation: latido 0.8s infinite; }

        /* --- UI TEXTO --- */
        #texto-globo {
            background: white; color: #222; padding: 25px 40px;
            border-radius: 50px; font-size: 1.8rem; text-align: center; max-width: 90%;
            box-shadow: 0 15px 0 rgba(0,0,0,0.1); font-weight: bold; margin-bottom: 20px;
            min-height: 100px; display: flex; align-items: center; justify-content: center;
            border: 6px solid white; transform: scale(0.9); opacity: 0; transition: 0.4s;
            position: relative; z-index: 20;
        }
        #texto-globo.visible { transform: scale(1); opacity: 1; }
        #texto-globo.alerta { color: #ff006e; font-size: 4rem; font-family: 'Bangers', cursive; text-shadow: 4px 4px 0 #000; letter-spacing: 3px; }

        /* --- BOTONES --- */
        #botones-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; width: 95%; z-index: 20; }
        .btn {
            padding: 25px 45px; font-size: 1.6rem; border: none; border-radius: 60px;
            cursor: pointer; font-family: 'Fredoka', sans-serif; font-weight: bold;
            transition: 0.1s; box-shadow: 0 10px 0 rgba(0,0,0,0.2); opacity: 0; transform: translateY(30px);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn.show { opacity: 1; transform: translateY(0); }
        .btn:active { transform: translateY(10px); box-shadow: 0 0 0; }
        .btn-a { background: white; color: #ff006e; }
        .btn-b { background: #3a86ff; color: white; }

        /* --- NUEVO SENSOR DUAL --- */
        #sensor-area { display: none; flex-direction: column; align-items: center; margin-top: 10px; z-index: 20; width: 100%; }
        #sensor-wrapper { display: flex; gap: 40px; justify-content: center; align-items: center; }
        
        .fingerprint-btn {
            font-size: 4rem; width: 130px; height: 130px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: 8px dashed white; display: flex;
            align-items: center; justify-content: center; cursor: pointer; animation: pulse 1.5s infinite;
            user-select: none; -webkit-tap-highlight-color: transparent; transition: 0.3s;
        }
        .fingerprint-btn.active { background: #fff; border-style: solid; animation: none; transform: scale(0.9); }
        
        /* Icono de resultado final (fusi√≥n) */
        #final-icon { display: none; font-size: 8rem; animation: latido 0.8s infinite; filter: drop-shadow(0 0 20px rgba(255,255,255,0.8)); }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: 0 0 0 30px rgba(255,255,255,0); } }
        @keyframes latido { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* MODAL FINAL CON MARCOS REACTIVOS */
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 5000; flex-direction:column; align-items:center; justify-content:center; }
        #polaroid { background: white; padding: 25px 25px 60px 25px; transform: rotate(-2deg); box-shadow: 0 0 80px rgba(255,0,110,0.6); text-align: center; max-width: 85%; border-radius: 10px; border: 15px solid white; transition: 0.3s; }
        
        .frame-gold { border-color: #ffd700 !important; box-shadow: 0 0 60px #ffd700 !important; }
        .frame-love { border-color: #ff006e !important; box-shadow: 0 0 60px #ff006e !important; }
        .frame-friend { border-color: #3a86ff !important; box-shadow: 0 0 60px #3a86ff !important; }
        .frame-toxic { border-color: #333 !important; box-shadow: 0 0 60px #555 !important; }

        #foto-result { width: 100%; max-width: 500px; border: 2px solid #eee; display: block; }
        #frase-final { font-family: 'Fredoka', sans-serif; color: #222; font-size: 1.5rem; margin-top: 20px; font-weight: bold; line-height: 1.3; }
        #timer-reset { position: absolute; top: 10px; right: 20px; color: white; font-size: 1.5rem; font-weight: bold; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; }

        #start-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg, #ff006e, #8338ec); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="flash-overlay"></div>
    <div id="emoji-layer"></div>

    <div id="start-screen">
        <h1 style="font-family: 'Bangers', cursive; font-size: 6rem; margin-bottom: 10px; text-shadow: 5px 5px 0px #000;">CUPIDO IMJU</h1>
        <h2 style="font-size: 2rem; margin-top: 0; opacity: 1;">ESCUINAPA üç§üö≤</h2>
        <p style="font-size: 1.8rem; margin-bottom: 10px; font-weight: bold;">¬°J√°lense plebes!</p>
        <p style="font-size: 1.4rem; margin-bottom: 40px; opacity: 0.9;">¬øHay futuro o nel? ¬°Vengan a descubrir su suerte!</p>
        <button class="btn btn-a show" id="btn-init" onclick="iniciarApp()" disabled>Iniciando Sistema...</button>
    </div>

    <div id="header-imju">
        <h1>IMJU ESCUINAPA</h1>
        <p>Juventud que Transforma</p>
    </div>

    <video id="webcam" autoplay playsinline muted></video>

    <div id="avatar-container">
        <div id="cabeza">
            <div class="cejas-row faccion-sombra"><div class="ceja"></div><div class="ceja"></div></div>
            <div class="ojos-row faccion-sombra">
                <div class="ojo-wrapper"><div class="pupila"></div><div class="brillo"></div></div>
                <div class="ojo-wrapper"><div class="pupila"></div><div class="brillo"></div></div>
            </div>
            <div class="boca faccion-sombra"></div>
        </div>
    </div>

    <div id="texto-globo">Esperando a la raza...</div>

    <div id="botones-container"></div>

    <div id="sensor-area">
        <div id="sensor-wrapper">
            </div>
        <div id="final-icon">üíñ</div> <p id="sensor-instruccion" style="font-weight:bold; margin-top:25px; font-size: 1.5rem; text-shadow: 0 2px 4px black;">MANT√âN PULSADO</p>
    </div>

    <div id="modal">
        <div id="timer-reset">Reiniciando en 20s...</div>
        <div id="polaroid">
            <img id="foto-result" src="">
            <div id="frase-final">An√°lisis...</div>
        </div>
        <div style="margin-top:20px; display:flex; gap:20px;">
            <button class="btn btn-b show" onclick="descargar()">GUARDAR FOTO</button>
            <button class="btn btn-a show" onclick="location.reload()">REINICIAR YA</button>
        </div>
    </div>

    <script>
        // --- VOZ ---
        let vozSeleccionada = null;
        window.speechSynthesis.onvoiceschanged = () => {
            const voces = window.speechSynthesis.getVoices();
            vozSeleccionada = voces.find(v => v.name.includes('Google') && v.lang.includes('es')) || 
                              voces.find(v => v.lang === 'es-MX');
        };

        // --- EMOJIS ---
        function crearEmojisFondo() {
            const emojis = ['üç§', 'üö≤', 'ü•≠', 'üå¥', '‚ù§Ô∏è', 'üåÆ', 'üåä', '‚òÄÔ∏è', 'üíñ', 'üéµ'];
            const container = document.getElementById('emoji-layer');
            setInterval(() => {
                const el = document.createElement('div');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.className = 'emoji-float';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.animationDuration = (Math.random() * 5 + 8) + 's';
                container.appendChild(el);
                setTimeout(() => el.remove(), 11000);
            }, 800);
        }
        crearEmojisFondo();

        // --- BASE DE DATOS (V16) ---
        const DB = {
            SOLO: {
                intro: [ "¬°Qu√© rollo! ¬øVienes solo? A ver qu√© dice la suerte hoy.", "¬øSoltero? ¬°Fierro! M√°s tiempo para la bici." ],
                preguntas: [
                    { q: "¬øQu√© prefieres el fin?", a: "Malec√≥n üåä", b: "Fiesta ü•Å", rA: "Tranquil√≥n.", rB: "¬°Fiestero!" },
                    { q: "¬øCenar√≠as tamales en la primera cita?", a: "¬°Claro! ü´î", b: "Algo fresa üçì", rA: "Orgullo local.", rB: "Uy, delicado." },
                    { q: "¬øPerdonar√≠as cuernos?", a: "Jam√°s üö´", b: "Tal vez... ü§î", rA: "Dignidad.", rB: "No lo haga compa." },
                    { q: "¬øBicicleta o Moto?", a: "Pura Bici üö≤", b: "Moto üèçÔ∏è", rA: "¬°Deporte!", rB: "Con casco, eh." },
                    { q: "¬øTe quieres casar?", a: "S√≠, bodorrio üíç", b: "Mejor viajar ‚úàÔ∏è", rA: "Ahorra feria.", rB: "Esp√≠ritu libre." }
                ],
                resultados: [
                    { t: "Soltero de Oro", d: "Eres un partidazo. Disfruta tu libertad, el amor llegar√° cuando menos lo esperes.", frame: "frame-gold", iconFinal: "üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®" },
                    { t: "Rom√°ntico", d: "No te desesperes, esa persona especial anda perdida en Teacap√°n.", frame: "frame-love", iconFinal: "üíò" },
                    { t: "Alma Libre", d: "Tu vibra es de libertad total. No necesitas a nadie para ser feliz.", frame: "frame-friend", iconFinal: "ü¶ã" }
                ],
                emojiBtn: "üë§"
            },
            PAREJA: {
                intro: [ "¬°Pareja a la vista! P√≥nganse de acuerdo qui√©n contesta.", "Se ven bien juntos. A ver si aguantan el test." ],
                preguntas: [
                    { q: "¬øQui√©n invita los camarones?", a: "√âl/Ella üç§", b: "Micha y micha", rA: "¬°Vale oro!", rB: "Parejos." },
                    { q: "¬øQui√©n es m√°s celoso?", a: "√âl/Ella üò°", b: "Yo mero üòí", rA: "Paciencia.", rB: "B√°jale al drama." },
                    { q: "¬øQui√©n maneja mejor la bici?", a: "√âl/Ella üö≤", b: "Yo", rA: "¬°Talento!", rB: "Hagan carreritas." },
                    { q: "¬øRevisar√≠an el celular?", a: "Nel ü§ù", b: "Pr√©stalo üëÄ", rA: "Amor sano.", rB: "¬°T√≥xicos!" },
                    { q: "¬øBesos en p√∫blico?", a: "S√≠, obvio üòò", b: "Me da pena üò≥", rA: "¬°Viva el amor!", rB: "Respetables." }
                ],
                resultados: [
                    { t: "Amor del Bueno", d: "Tienen una conexi√≥n b√°rbara, sigan as√≠ de unidos.", frame: "frame-love", iconFinal: "üíñ" },
                    { t: "Pareja Dinamita", d: "Son pura energ√≠a. Se aman con intensidad, pero b√°jenle al drama.", frame: "frame-love", iconFinal: "üî•" },
                    { t: "Polos Opuestos", d: "Son diferentes pero se complementan. Uno pone la calma y el otro el desorden.", frame: "frame-friend", iconFinal: "‚òØÔ∏è" }
                ],
                emojiBtn: "‚ù§Ô∏è"
            },
            AMIGOS: {
                intro: [ "¬°Puro compa aqu√≠! Lealtad ante todo. Uno responde.", "La clika de Escuinapa. A ver qui√©n es el l√≠der." ],
                preguntas: [
                    { q: "¬øQui√©n baila mejor?", a: "Mi compa üíÉ", b: "Yo", rA: "¬°Saca los pasos!", rB: "El alma de la fiesta." },
                    { q: "¬øQui√©n debe dinero?", a: "Yo üôà", b: "Me debe feria üò†", rA: "P√°gale los 20.", rB: "C√≥brale." },
                    { q: "¬øQui√©n picha la cena?", a: "Este compa üçî", b: "Yo invito", rA: "¬°Buen amigo!", rB: "Generoso." },
                    { q: "¬øGuardar√≠an un secreto?", a: "A la tumba ‚ö∞Ô∏è", b: "Se me sale üôä", rA: "Lealtad.", rB: "Aguas contigo." },
                    { q: "¬øIr√≠an de viaje?", a: "¬°V√°monos! ‚úàÔ∏è", b: "Nos matamos", rA: "Maletas listas.", rB: "Mejor de lejitos." }
                ],
                resultados: [
                    { t: "Compas de Acero", d: "Amistad a prueba de balas. Siempre se van a respaldar.", frame: "frame-friend", iconFinal: "ü§ù" },
                    { t: "Socios del Crimen", d: "Cuidado con ustedes dos. Tienen una complicidad √∫nica.", frame: "frame-toxic", iconFinal: "üòé" },
                    { t: "Hermanos", d: "Lo suyo es hermandad. Se conocen todo y se quieren.", frame: "frame-gold", iconFinal: "ü§û" }
                ],
                emojiBtn: "‚úã"
            }
        };

        // VARIABLES
        let model, video, trackingReq;
        let currentMode = null, questionQueue = [], qIndex = 0, isSpeaking = false;
        const textBubble = document.getElementById('texto-globo');
        const btnContainer = document.getElementById('botones-container');
        const sensorInstruccion = document.getElementById('sensor-instruccion');
        const sensorWrapper = document.getElementById('sensor-wrapper');
        const NUM_PREGUNTAS = 5;

        // INICIO
        async function setup() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video = document.getElementById('webcam');
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                model = await blazeface.load();
                document.getElementById('btn-init').innerText = "¬°DALE GAS!";
                document.getElementById('btn-init').disabled = false;
            } catch(e) { alert("Activa la c√°mara pariente."); }
        }
        setup();

        function iniciarApp() {
            document.getElementById('start-screen').style.display = 'none';
            loopOjos(); 
            setEmocion('sospecha');
            hablar("¬°Qu√© rollo plebes! Soy el Cupido del I.M.J.U. Escuinapa. Vengo a leer sus vibras.", () => {
                setTimeout(preguntarModo, 1000);
            });
        }

        // L√ìGICA DE JUEGO
        function preguntarModo() {
            setEmocion('sorpresa');
            mostrarTexto("¬øQui√©n anda ah√≠?");
            mostrarBotones([
                { txt: "Ando Solo/a ü§†", val: "SOLO" },
                { txt: "Somos Pareja ‚ù§Ô∏è", val: "PAREJA" },
                { txt: "Somos Amigos ‚úåÔ∏è", val: "AMIGOS" }
            ]);
        }

        function handleSeleccion(val) {
            if (["SOLO", "PAREJA", "AMIGOS"].includes(val)) {
                currentMode = val;
                prepararJuego();
            } else if (val === "A" || val === "B") handleRespuesta(val);
        }

        function prepararJuego() {
            const data = DB[currentMode];
            questionQueue = [...data.preguntas].sort(() => 0.5 - Math.random()).slice(0, NUM_PREGUNTAS);
            qIndex = 0;
            const introRandom = data.intro[Math.floor(Math.random() * data.intro.length)];
            setEmocion('hablando');
            hablar(introRandom, siguientePregunta);
        }

        function siguientePregunta() {
            if (qIndex >= questionQueue.length) { faseSensor(); return; }
            const q = questionQueue[qIndex];
            setEmocion('sospecha');
            setTimeout(() => {
                setEmocion('normal');
                mostrarTexto(q.q);
                hablar(q.q, () => { 
                    setTimeout(() => {
                        mostrarBotones([{ txt: q.a, val: "A" }, { txt: q.b, val: "B" }]);
                    }, 800);
                });
            }, 1000);
        }

        function handleRespuesta(opcion) {
            const q = questionQueue[qIndex];
            const reaccion = opcion === "A" ? q.rA : q.rB;
            if (reaccion.includes("!")) setEmocion('sorpresa'); 
            else if (reaccion.includes("amor") || reaccion.includes("bien")) setEmocion('feliz');
            else setEmocion('hablando');
            
            mostrarTexto(reaccion);
            hablar(reaccion, () => {
                qIndex++;
                siguientePregunta();
            });
        }

        // --- SENSOR DUAL INTELIGENTE ---
        let activeFingers = 0;
        let sensorTimer;
        let requiredFingers = 1;

        function faseSensor() {
            setEmocion('sospecha');
            sensorWrapper.innerHTML = ""; // Limpiar
            const data = DB[currentMode];
            requiredFingers = (currentMode === "SOLO") ? 1 : 2;

            // Generar botones
            for(let i=0; i<requiredFingers; i++) {
                let div = document.createElement('div');
                div.className = "fingerprint-btn";
                div.innerHTML = data.emojiBtn;
                div.id = "finger-" + i;
                
                // EVENTOS TOUCH Y MOUSE
                div.addEventListener('mousedown', () => fingerDown(i));
                div.addEventListener('mouseup', () => fingerUp(i));
                div.addEventListener('touchstart', (e) => { e.preventDefault(); fingerDown(i); });
                div.addEventListener('touchend', (e) => { e.preventDefault(); fingerUp(i); });
                div.addEventListener('mouseleave', () => fingerUp(i));

                sensorWrapper.appendChild(div);
            }

            const txt = (currentMode === "SOLO") ? "Pon tu dedo en la huella." : "¬°Pongan sus dedos AL MISMO TIEMPO!";
            mostrarTexto("¬°Hora de la verdad!");
            hablar(txt, () => {
                btnContainer.innerHTML = "";
                document.getElementById('sensor-area').style.display = 'flex';
                activeFingers = 0;
            });
        }

        function fingerDown(index) {
            const btn = document.getElementById("finger-" + index);
            if(btn.classList.contains('active')) return;
            
            btn.classList.add('active');
            
            // Hack para PC: Si no es modo solo y usas mouse, activamos los dos para poder probar
            if(requiredFingers === 2 && !('ontouchstart' in window)) {
                document.querySelectorAll('.fingerprint-btn').forEach(b => b.classList.add('active'));
                activeFingers = 2;
            } else {
                activeFingers++;
            }

            checkSensorStatus();
        }

        function fingerUp(index) {
            const btn = document.getElementById("finger-" + index);
            if(!btn.classList.contains('active')) return;
            
            btn.classList.remove('active');
            
            if(requiredFingers === 2 && !('ontouchstart' in window)) {
                document.querySelectorAll('.fingerprint-btn').forEach(b => b.classList.remove('active'));
                activeFingers = 0;
            } else {
                activeFingers--;
            }
            
            checkSensorStatus();
        }

        function checkSensorStatus() {
            clearTimeout(sensorTimer);
            if (activeFingers >= requiredFingers) {
                sensorInstruccion.innerText = "¬°NO SUELTEN!";
                sensorInstruccion.style.color = "#ffbe0b";
                mostrarTexto("LEYENDO VIBRAS...");
                sensorTimer = setTimeout(exitoSensor, 3000);
            } else {
                if (document.getElementById('sensor-area').style.display === 'flex') {
                    sensorInstruccion.innerText = "MANT√âN PULSADO";
                    sensorInstruccion.style.color = "white";
                    // Si soltaron a medio proceso
                    if(activeFingers > 0) mostrarTexto("¬°Falta uno!");
                }
            }
        }

        function exitoSensor() {
            document.getElementById('sensor-wrapper').style.display = 'none';
            const icon = document.getElementById('final-icon');
            
            const resultados = DB[currentMode].resultados;
            const res = resultados[Math.floor(Math.random() * resultados.length)];
            
            // TRANSICI√ìN DE ICONO
            icon.innerText = res.iconFinal;
            icon.style.display = 'block';
            setEmocion('enamorado');
            
            mostrarTexto("¬°AN√ÅLISIS COMPLETO!");
            hablar(`¬°Fierro! Ustedes son: ${res.t}. ¬°Acom√≥dense el cabello plebes, que va la foto!`, () => {
                setTimeout(() => cuentaRegresivaFoto(res), 1000);
            });
        }

        function cuentaRegresivaFoto(resFinal) {
            setEmocion('feliz');
            cancelAnimationFrame(trackingReq); 
            let count = 3;
            textBubble.classList.add('alerta'); 

            const interval = setInterval(() => {
                 if(count > 0) {
                     mostrarTexto(count);
                     count--;
                 } else {
                     clearInterval(interval);
                     mostrarTexto("¬°SONR√çAN! üì∏");
                     tomarFoto(resFinal);
                 }
            }, 1000);
        }

        function tomarFoto(res) {
            const flash = document.getElementById('flash-overlay');
            flash.classList.add('flash-active');
            setTimeout(() => flash.classList.remove('flash-active'), 150);

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            
            document.getElementById('foto-result').src = canvas.toDataURL('image/jpeg');
            document.getElementById('frase-final').innerText = `${res.t}: ${res.d}`;
            
            // MARCO DIN√ÅMICO
            const polaroid = document.getElementById('polaroid');
            polaroid.className = ""; 
            polaroid.classList.add(res.frame);
            
            document.getElementById('modal').style.display = 'flex';
            iniciarAutoReset();
        }

        function iniciarAutoReset() {
            let timeLeft = 20;
            const timerEl = document.getElementById('timer-reset');
            const interval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = `Reiniciando en ${timeLeft}s...`;
                if(timeLeft <= 0) {
                    clearInterval(interval);
                    location.reload();
                }
            }, 1000);
        }

        async function loopOjos() {
            const preds = await model.estimateFaces(video, false);
            if (preds.length > 0) {
                const p = preds[0];
                const x = (p.topLeft[0] + p.bottomRight[0]) / 2;
                const y = (p.topLeft[1] + p.bottomRight[1]) / 2;
                const xEye = (x / video.videoWidth - 0.5) * 60; 
                const yEye = (y / video.videoHeight - 0.5) * 50;
                document.querySelectorAll('.pupila').forEach(pup => {
                    pup.style.transform = `translate(${xEye}px, ${yEye}px)`;
                });
            }
            trackingReq = requestAnimationFrame(loopOjos);
        }

        function setEmocion(emo) {
            const cabeza = document.getElementById('cabeza');
            cabeza.className = ""; 
            if (emo !== 'normal') cabeza.classList.add(emo);
        }

        function hablar(texto, callback) {
            window.speechSynthesis.cancel();
            isSpeaking = true;
            const u = new SpeechSynthesisUtterance(texto);
            if (vozSeleccionada) u.voice = vozSeleccionada;
            u.lang = "es-MX";
            
            if (texto.includes("!")) { u.rate = 1.15; u.pitch = 1.2; }
            else if (texto.includes("?")) { u.rate = 1.0; u.pitch = 1.1; }
            else if (texto.includes("...")) { u.rate = 0.9; u.pitch = 0.9; }
            else { u.rate = 1.0; u.pitch = 1.0; }

            u.onstart = () => document.getElementById('cabeza').classList.add('hablando');
            u.onend = () => {
                document.getElementById('cabeza').classList.remove('hablando');
                isSpeaking = false;
                if(callback) callback();
            };
            window.speechSynthesis.speak(u);
        }

        function mostrarTexto(txt) {
            textBubble.innerText = txt;
            textBubble.classList.add('visible');
        }

        function mostrarBotones(lista) {
            btnContainer.innerHTML = "";
            lista.forEach((item, i) => {
                const btn = document.createElement('button');
                btn.className = i === 0 ? "btn btn-a" : "btn btn-b";
                btn.innerText = item.txt;
                btn.onclick = () => { btnContainer.innerHTML = ""; handleSeleccion(item.val); };
                btnContainer.appendChild(btn);
                setTimeout(() => btn.classList.add('show'), i * 150);
            });
        }

        function descargar() {
            const a = document.createElement('a');
            a.href = document.getElementById('foto-result').src;
            a.download = "CupidoIMJUEscuinapa.jpg";
            a.click();
        }
    </script>
</body>
</html>
