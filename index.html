<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>OrÃ¡culo Social IA v72</title>

<!-- TF + BlazeFace -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

<style>
body{
  margin:0;
  height:100vh;
  overflow:hidden;
  background:#000;
  font-family:'Segoe UI',sans-serif;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
}

#webcam{
  position:fixed;
  width:100%;
  height:100%;
  object-fit:cover;
  transform:scaleX(-1);
  opacity:.4;
}

#fondo{
  position:fixed;
  inset:0;
  background:radial-gradient(circle,#0d47a1,#000);
  mix-blend-mode:hard-light;
}

#ui{
  position:relative;
  z-index:10;
  text-align:center;
  max-width:90%;
}

#dialogo{
  font-size:24px;
  margin-top:20px;
  min-height:80px;
}

button{
  margin-top:20px;
  padding:15px 35px;
  border-radius:30px;
  border:1px solid white;
  background:rgba(0,0,0,.6);
  color:white;
  cursor:pointer;
}

#sensor{
  display:none;
  position:fixed;
  bottom:40px;
  width:90px;
  height:90px;
  border-radius:50%;
  border:2px solid white;
  display:flex;
  align-items:center;
  justify-content:center;
}
</style>
</head>

<body>

<video id="webcam" autoplay playsinline muted></video>
<div id="fondo"></div>

<div id="ui">
  <div id="status">ESPERANDO INICIO</div>
  <div id="dialogo"></div>
  <button onclick="iniciar()">INICIAR</button>
</div>

<div id="sensor">ðŸ‘†</div>


<script type="module">

/* =========================
   GEMINI DIRECTO (LOCAL)
========================= */

import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

const API_KEY = "AIzaSyBlJGQaWafqiSuituKURcRriR3t18YBnOs";

const genAI = new GoogleGenerativeAI(API_KEY);

const model = genAI.getGenerativeModel({
  model: "gemini-1.5-flash"
});

async function pedirGemini(prompt){
  try{
    const result = await model.generateContent(prompt);
    const response = await result.response;
    return response.text();
  }catch(e){
    console.error("Gemini:",e);
    return "Las energÃ­as estÃ¡n inestables...";
  }
}


/* =========================
   ELEMENTOS
========================= */

const video = document.getElementById("webcam");
const dialogo = document.getElementById("dialogo");
const status = document.getElementById("status");
const sensor = document.getElementById("sensor");

let modeloCara;
let estado="OFF";
let nombre="Viajero";


/* =========================
   VOZ
========================= */

let voz=null;

speechSynthesis.onvoiceschanged = ()=>{
  voz = speechSynthesis.getVoices().find(v=>v.lang.includes("es")) || null;
};

function hablar(txt,cb){
  dialogo.innerText = txt;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(txt);
  if(voz) u.voice = voz;
  u.onend = ()=>cb && cb();
  speechSynthesis.speak(u);
}


/* =========================
   ESCUCHA
========================= */

function escuchar(cb){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  if(!SR){
    const r = prompt("Escribe tu respuesta:");
    cb(r);
    return;
  }

  const rec = new SR();
  rec.lang="es-MX";

  rec.onresult = e=>{
    cb(e.results[0][0].transcript);
  };

  rec.start();
}


/* =========================
   CÃMARA + DETECCIÃ“N
========================= */

async function iniciar(){

  status.innerText="CARGANDO...";

  const stream = await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;

  modeloCara = await blazeface.load();

  estado="BUSCANDO";

  detectar();

  status.innerText="ACÃ‰RCATE";
}


async function detectar(){

  if(estado==="OFF") return;

  if(video.readyState >= 2){
    const preds = await modeloCara.estimateFaces(video,false);

    if(preds.length>0 && estado==="BUSCANDO"){
      estado="CHARLANDO";
      flujoInicio();
    }
  }

  requestAnimationFrame(detectar);
}


/* =========================
   FLUJO SOCIAL
========================= */

async function flujoInicio(){

  const saludo = await pedirGemini("Saluda de forma cÃ¡lida y pregunta el nombre.");
  hablar(saludo,()=>{
    escuchar(async r=>{
      nombre=r||"Viajero";

      const inv = await pedirGemini(`Su nombre es ${nombre}. InvÃ­talo a participar en una lectura de aura.`);
      hablar(inv,()=>{
        flujoPreguntas();
      });
    });
  });
}


async function flujoPreguntas(){

  let preguntas=4;

  const hacer=async()=>{
    if(preguntas<=0){
      sensor.style.display="flex";
      hablar("Coloca tu dedo para analizar tu energÃ­a.");
      return;
    }

    const p = await pedirGemini("Haz una pregunta reflexiva breve.");
    hablar(p,()=>{
      escuchar(async r=>{
        preguntas--;
        hacer();
      });
    });
  }

  hacer();
}


/* =========================
   SENSOR AURA
========================= */

sensor.addEventListener("click",async()=>{

  sensor.style.display="none";
  status.innerText="ANALIZANDO AURA...";

  const res = await pedirGemini(`Describe el aura de ${nombre} con color y cumplido positivo.`);

  hablar(res,()=>{
    estado="BUSCANDO";
    status.innerText="ACÃ‰RCATE";
  });

});

</script>
</body>
</html>
