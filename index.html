<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OrÃ¡culo Social v70 - Gemini Native</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        /* TUS ESTILOS ORIGINALES (Mantenidos para preservar la estÃ©tica) */
        body { margin: 0; height: 100vh; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; user-select: none; }
        
        #status-bar { 
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.6); border: 1px solid #444; border-radius: 50px;
            padding: 8px 30px; font-weight: bold; font-size: 13px; z-index: 2000;
            display: flex; gap: 10px; align-items: center; text-transform: uppercase; letter-spacing: 1px;
            backdrop-filter: blur(5px);
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: gray; transition: 0.3s; }
        
        #webcam { position: fixed; top: 0; left: 0; opacity: 0; pointer-events: none; }
        #fondo-dinamico { position: fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at 50% 50%, #0d47a1, #000); z-index: 0; transition: background 2s ease; }
        #particulas { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 1; pointer-events: none; }
        #flash-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: white; opacity: 0; pointer-events: none; z-index: 5000; transition: opacity 1.5s ease-in-out; }

        #cabeza { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; display: flex; flex-direction: column; align-items: center; transition: transform 0.3s; }
        .ojos-container { display: flex; gap: 40px; }
        .ojo { width: 140px; height: 200px; background: white; border-radius: 50%; position: relative; box-shadow: 0 0 60px rgba(255,255,255,0.3); overflow: hidden; border: 4px solid rgba(255,255,255,0.1); transition: 0.3s; }
        .pupila { width: 50px; height: 60px; background: #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: 0.1s; }
        .parpado { position: absolute; width: 100%; background: #000; transition: 0.3s; z-index: 5; left: 0; }
        .top { top: 0; height: 10%; } .bottom { bottom: 0; height: 10%; }
        .boca { width: 40px; height: 5px; background: white; border-radius: 20px; margin-top: 30px; transition: 0.3s; opacity: 0.8; }

        /* Estados de animaciÃ³n */
        .zen .top, .zen .bottom { height: 45%; } 
        .atento .top, .atento .bottom { height: 10%; }
        .sorpresa .ojo { transform: scale(1.15); border-color: #ffd700; box-shadow: 0 0 80px #ffd700; }
        .hablando .boca { animation: hablar 0.2s infinite alternate; }
        @keyframes hablar { from { height: 5px; width: 40px; } to { height: 25px; width: 65px; } }

        #ui-container { position: fixed; top: 15%; width: 100%; text-align: center; pointer-events: none; z-index: 100; }
        #texto-principal { font-size: 2.2rem; text-shadow: 0 4px 15px rgba(0,0,0,0.9); font-weight: 700; transition: opacity 0.5s; padding: 0 20px; min-height: 100px; max-width: 800px; margin: 0 auto; }
        #mic-icon { font-size: 4rem; margin-top: 20px; opacity: 0; transition: 0.3s; text-shadow: 0 0 40px #00e676; display:none; }
        .mic-activo { display: block !important; animation: latido 1s infinite; opacity: 1 !important; }
        @keyframes latido { 0% {transform: scale(1);} 50% {transform: scale(1.2);} 100% {transform: scale(1);} }

        #botones { position: fixed; bottom: 20%; display: none; gap: 40px; z-index: 200; pointer-events: auto; }
        .btn { padding: 20px 60px; font-size: 1.5rem; border: 3px solid white; background: rgba(0,0,0,0.8); color: white; border-radius: 50px; cursor: pointer; transition: 0.2s; font-weight: bold; backdrop-filter: blur(4px); }
        .btn:hover { background: white; color: black; transform: scale(1.1); box-shadow: 0 0 30px white; }

        #sensor { position: fixed; bottom: 100px; display: none; width: 120px; height: 120px; border: 4px solid white; border-radius: 50%; align-items: center; justify-content: center; font-size: 4rem; cursor: pointer; pointer-events: auto; z-index: 200; transition: 0.3s; background: rgba(255,255,255,0.1); }
        #sensor.activo { background: white; color: black; box-shadow: 0 0 120px white; transform: scale(0.95); }

        #inicio { position: fixed; top:0; left:0; width:100%; height:100%; background:black; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index: 9999; }
        #btn-init { padding: 30px 80px; font-size: 1.8rem; border: 2px solid #00e676; background: transparent; color: #00e676; border-radius: 60px; cursor: pointer; font-weight: bold; letter-spacing: 2px; transition: 0.3s; }
        #btn-init:hover { background: #00e676; color: black; box-shadow: 0 0 40px #00e676; }
        #btn-init:disabled { opacity: 0.5; cursor: wait; border-color: gray; color: gray; }

        #monitor-cam { position: fixed; bottom: 10px; right: 10px; width: 100px; height: 75px; border: 1px solid #333; z-index: 50; transform: scaleX(-1); background:black; opacity: 0.3; border-radius: 10px; overflow: hidden; }
        #canvas-monitor { width:100%; height:100%; object-fit:cover; }
    </style>
</head>
<body>

    <div id="status-bar">
        <div id="dot-status" class="dot"></div>
        <span id="text-status">SISTEMA INICIANDO...</span>
    </div>

    <div id="monitor-cam"><canvas id="canvas-monitor"></canvas></div>
    <video id="webcam" autoplay playsinline muted width="640" height="480"></video>

    <div id="inicio">
        <button id="btn-init" onclick="arrancarSistema()" disabled>CARGANDO CORE...</button>
    </div>

    <canvas id="particulas"></canvas>
    <div id="fondo-dinamico"></div>
    <div id="flash-overlay"></div>

    <div id="cabeza" class="zen">
        <div class="ojos-container">
            <div class="ojo"><div class="parpado top"></div><div class="pupila"></div><div class="brillo"></div><div class="parpado bottom"></div></div>
            <div class="ojo"><div class="parpado top"></div><div class="pupila"></div><div class="brillo"></div><div class="parpado bottom"></div></div>
        </div>
        <div class="boca"></div>
    </div>

    <div id="ui-container">
        <div id="texto-principal"></div>
        <div id="mic-icon">ðŸ‘‚</div>
    </div>

    <div id="botones">
        <button class="btn" onclick="respuestaBoton('si')">CONECTAR</button>
        <button class="btn" style="border-color: #ff4444" onclick="respuestaBoton('no')">AHORA NO</button>
    </div>

    <div id="sensor" onmousedown="tocarSensor()" onmouseup="soltarSensor()" ontouchstart="tocarSensor()" ontouchend="soltarSensor()">ðŸ‘†</div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- CONFIGURACIÃ“N CRÃTICA ---
        // TU API KEY INTEGRADA
        const API_KEY = "AIzaSyBlJGQaWafqiSuituKURcRriR3t18YBnOs"; 
        
        // --- Variables del Sistema ---
        let genAI, model, chatSession;
        let estado = "OFF"; 
        let isSpeaking = false;
        let modeloVision;
        
        // Elementos UI
        const cabeza = document.getElementById('cabeza');
        const texto = document.getElementById('texto-principal');
        const micIcon = document.getElementById('mic-icon');
        const fondo = document.getElementById('fondo-dinamico');
        const monitor = document.getElementById('canvas-monitor');
        const ctxMonitor = monitor.getContext('2d');
        const video = document.getElementById('webcam');

        // AnimaciÃ³n variables
        let targetX = window.innerWidth/2, targetY = window.innerHeight/2;
        let currentX = window.innerWidth/2, currentY = window.innerHeight/2;
        let scaleTarget = 1, scaleCurrent = 1;

        // 1. INICIALIZACIÃ“N ROBUSTA
        window.onload = async () => {
            try {
                // Configurar Gemini con una personalidad fuerte
                genAI = new GoogleGenerativeAI(API_KEY);
                model = genAI.getGenerativeModel({ 
                    model: "gemini-1.5-flash",
                    systemInstruction: "Eres un OrÃ¡culo Digital MÃ­stico. Tu objetivo es leer el aura del usuario. IMPORTANTE: Haz 2 o 3 preguntas filosÃ³ficas breves al usuario para conocerlo. DESPUÃ‰S de esas preguntas, dile OBLIGATORIAMENTE que 'coloque su dedo en el sensor para finalizar'. Tus respuestas deben ser cortas (mÃ¡ximo 15 palabras) y mÃ­sticas. No te repitas."
                });

                // Configurar CÃ¡mara
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                monitor.width = video.videoWidth; monitor.height = video.videoHeight;

                // Cargar VisiÃ³n
                modeloVision = await blazeface.load();

                // Habilitar BotÃ³n
                const btn = document.getElementById('btn-init');
                btn.innerText = "INICIAR RITUAL";
                btn.disabled = false;
                btn.style.color = "#00e676";
                btn.style.borderColor = "#00e676";
                setStatus("LISTO", "#00e676");

                // Iniciar Loops Visuales
                animLoop(); animParticulas(); detectarLoop();

            } catch (e) {
                console.error(e);
                alert("Error de inicio: " + e.message + ". Verifica HTTPS y la API Key.");
            }
        };

        window.arrancarSistema = function() {
            document.getElementById('inicio').style.opacity = 0;
            setTimeout(() => document.getElementById('inicio').style.display = 'none', 1000);
            
            // Truco para desbloquear audio en navegadores modernos
            try { new AudioContext().resume(); } catch(e){}
            
            iniciarChat();
        }

        // 2. CEREBRO DE GEMINI (Chat con Memoria)
        async function iniciarChat() {
            estado = "IDLE";
            chatSession = model.startChat({
                history: [
                    { role: "user", parts: [{ text: "Sistema iniciado. Estoy listo." }] },
                    { role: "model", parts: [{ text: "Sistemas en lÃ­nea. Percibo una presencia..." }] },
                ],
            });
            esperarRostro();
        }

        async function hablarConGemini(mensajeUsuario) {
            setStatus("CONECTANDO...", "cyan");
            try {
                const result = await chatSession.sendMessage(mensajeUsuario);
                const respuesta = result.response.text();
                setStatus("EN LÃNEA", "#00e676");
                return respuesta;
            } catch (error) {
                console.error("Error Gemini:", error);
                setStatus("ERROR RED", "red");
                return "La red cÃ³smica estÃ¡ inestable... dime, Â¿quiÃ©n eres?";
            }
        }

        // 3. FLUJO "SOCIAL" Y NATURAL
        function esperarRostro() {
            texto.innerText = "BUSCANDO ENERGÃA...";
            setEmocion("zen");
            estado = "BUSCANDO";
        }

        async function rostroDetectado() {
            if(estado !== "BUSCANDO") return;
            estado = "SALUDO";
            setEmocion("sorpresa"); // Abre los ojos al ver a alguien
            
            // Paso 1: Saludo inicial generado por IA (No hardcodeado)
            let saludo = await hablarConGemini("Un usuario acaba de aparecer frente a la cÃ¡mara. SalÃºdalo con misterio y pregÃºntale su nombre.");
            
            hablar(saludo, () => {
                escucharRespuesta(async (nombre) => {
                    // Paso 2: Usar el nombre para invitar
                    let invitacion = await hablarConGemini(`El usuario dice que se llama "${nombre}". InvÃ­talo a un ritual de lectura de aura.`);
                    hablar(invitacion, () => {
                        document.getElementById('botones').style.display = 'flex';
                    });
                });
            });
        }

        window.respuestaBoton = async function(opcion) {
            document.getElementById('botones').style.display = 'none';
            if (opcion === 'si') {
                let txt = await hablarConGemini("El usuario aceptÃ³. Hazle la primera pregunta filosÃ³fica.");
                hablar(txt, () => conversacionFluida()); // Inicia el bucle de charla
            } else {
                hablar("El destino espera. Hasta luego.", esperarRostro);
            }
        };

        // Bucle de conversaciÃ³n natural (sin contadores fijos)
        async function conversacionFluida() {
            escucharRespuesta(async (respuestaUsuario) => {
                setEmocion("atento");
                // Enviamos la respuesta a Gemini y dejamos que Ã©l decida quÃ© decir o preguntar despuÃ©s
                let respuestaIA = await hablarConGemini(`El usuario respondiÃ³: "${respuestaUsuario}". Si ya preguntaste suficiente, dile que ponga el dedo en el sensor. Si no, haz otra pregunta.`);
                
                // Detectar si la IA pide el sensor
                if (respuestaIA.toLowerCase().includes("sensor") || respuestaIA.toLowerCase().includes("dedo")) {
                    hablar(respuestaIA, prepararSensor);
                } else {
                    hablar(respuestaIA, () => conversacionFluida()); // Seguir charlando
                }
            });
        }

        function prepararSensor() {
            document.getElementById('sensor').style.display = 'flex';
            setEmocion("zen");
        }

        // 4. EL FINAL MÃSTICO
        window.tocarSensor = function() {
            document.getElementById('sensor').classList.add('activo');
            texto.innerText = "LEYENDO...";
            sonidoCuenco();
            setTimeout(async () => {
                document.getElementById('sensor').style.display = 'none';
                
                // Pedir veredicto final a Gemini basado en TODA la charla anterior
                let veredicto = await hablarConGemini("Genera el veredicto final. 1. Define un color de aura (Rojo, Azul, Dorado o Violeta). 2. Da una predicciÃ³n futura crÃ­ptica.");
                
                // Efectos visuales segÃºn la respuesta
                let color = "#fff";
                if(veredicto.includes("Rojo")) color = "#ff1744";
                if(veredicto.includes("Azul")) color = "#00e5ff";
                if(veredicto.includes("Dorado")) color = "#ffd700";
                if(veredicto.includes("Violeta")) color = "#d500f9";

                triggerFlash(color);
                
                hablar(veredicto, () => {
                    setTimeout(() => hablar("La sesiÃ³n ha terminado. Regresa cuando las estrellas se alineen.", esperarRostro), 5000);
                });

            }, 3000);
        }

        window.soltarSensor = function() {
            document.getElementById('sensor').classList.remove('activo');
        }

        // 5. SISTEMAS DE E/S (Voz y VisiÃ³n)
        
        function hablar(txt, callback) {
            isSpeaking = true;
            micIcon.style.display = 'none'; micIcon.classList.remove('mic-active');
            texto.innerText = txt;
            window.speechSynthesis.cancel();
            
            const u = new SpeechSynthesisUtterance(txt);
            // Intentar voz latina
            const voces = window.speechSynthesis.getVoices();
            const voz = voces.find(v => v.lang.includes('es-MX') || v.lang.includes('es'));
            if(voz) u.voice = voz;
            u.rate = 1.0;
            
            u.onstart = () => cabeza.classList.add('hablando');
            u.onend = () => {
                cabeza.classList.remove('hablando');
                isSpeaking = false;
                if(callback) callback();
            };
            window.speechSynthesis.speak(u);
        }

        function escucharRespuesta(callback) {
            if(isSpeaking) return;
            micIcon.style.display = 'block'; micIcon.classList.add('mic-active');
            texto.innerText = "ESCUCHANDO...";

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                // Fallback para navegadores sin soporte
                let r = prompt("Tu navegador no soporta voz. Escribe tu respuesta:");
                callback(r || "Silencio");
                return;
            }

            const rec = new SpeechRecognition();
            rec.lang = 'es-MX';
            rec.interimResults = false;
            rec.maxAlternatives = 1;

            rec.onresult = (e) => {
                micIcon.classList.remove('mic-active');
                callback(e.results[0][0].transcript);
            };
            rec.onerror = () => {
                micIcon.classList.remove('mic-active');
                callback("No entendÃ­, continÃºa."); // Evita atascos si hay silencio
            };
            rec.start();
        }

        // --- LÃ“GICA VISUAL (Blazeface) ---
        async function detecting() {
            if(estado === "OFF") return;
            
            // Dibujar en monitor (espejo)
            ctxMonitor.save(); ctxMonitor.scale(-1, 1);
            ctxMonitor.drawImage(video, -monitor.width, 0, monitor.width, monitor.height);
            ctxMonitor.restore();

            const predictions = await modeloVision.estimateFaces(video, false);
            if (predictions.length > 0) {
                const p = predictions[0];
                const start = p.topLeft;
                const end = p.bottomRight;
                const size = end[0] - start[0];
                
                // Mapear movimiento de cabeza
                let faceX = (start[0] + end[0]) / 2;
                let faceY = (start[1] + end[1]) / 2;
                targetX = (1 - (faceX / video.videoWidth)) * window.innerWidth;
                targetY = (faceY / video.videoHeight) * window.innerHeight;

                // ACTIVADOR DE SALUDO (Si estÃ¡ buscando y la cara estÃ¡ cerca)
                if(estado === "BUSCANDO" && size > 30) { 
                    rostroDetectado();
                }
            } else {
                if(estado === "BUSCANDO") { targetX = window.innerWidth/2; targetY = window.innerHeight/2; }
            }
            requestAnimationFrame(detecting);
        }
        window.detectarLoop = detecting;

        // --- UTILIDADES ---
        function animLoop() {
            currentX += (targetX - currentX) * 0.1;
            currentY += (targetY - currentY) * 0.1;
            cabeza.style.transform = `translate(-50%, -50%) translate(${currentX - window.innerWidth/2}px, ${currentY - window.innerHeight/2}px) scale(${scaleCurrent})`;
            requestAnimationFrame(animLoop);
        }
        function triggerFlash(color) {
            fondo.style.background = `radial-gradient(circle at 50% 50%, ${color}, #000)`;
            texto.style.color = color;
            document.getElementById('flash-overlay').style.opacity = 1;
            setTimeout(() => document.getElementById('flash-overlay').style.opacity = 0, 1000);
        }
        function setStatus(t, c) { document.getElementById('text-status').innerText = t; document.getElementById('dot-status').style.background = c; }
        function setEmocion(e) { cabeza.className = e; }

        // Audio simplificado
        let audioCtx;
        function sonidoCuenco() { if(!audioCtx) audioCtx = new AudioContext(); crearOsc(150, 2); }
        function crearOsc(f,t) {
            let o=audioCtx.createOscillator(), g=audioCtx.createGain();
            o.frequency.value = f; g.gain.value = 0.05;
            o.connect(g); g.connect(audioCtx.destination); o.start();
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + t);
            o.stop(audioCtx.currentTime + t);
        }
        
        // Particulas
        const ctxParts = document.getElementById('particulas').getContext('2d');
        let parts = Array.from({length:50},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,vx:(Math.random()-.5),vy:(Math.random()-.5)}));
        function animParticulas(){
            ctxParts.clearRect(0,0,innerWidth,innerHeight); ctxParts.fillStyle="rgba(255,255,255,0.3)";
            parts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>innerWidth)p.vx*=-1;if(p.y<0||p.y>innerHeight)p.vy*=-1;ctxParts.beginPath();ctxParts.arc(p.x,p.y,2,0,Math.PI*2);ctxParts.fill();});
            requestAnimationFrame(animParticulas);
        }

    </script>
</body>
</html>
