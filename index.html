<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oráculo Viviente v3.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

    <style>
        /* --- ESTÉTICA MÍSTICA --- */
        :root { --color-primary: #00f7ff; --color-glow: rgba(0, 247, 255, 0.4); }
        body { 
            margin: 0; height: 100vh; overflow: hidden; 
            background: #000; 
            font-family: 'Courier New', sans-serif; 
            color: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }

        /* CÁMARA INVISIBLE (Esencial para que funcione la detección) */
        #webcam { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; pointer-events: none; z-index: -10;
        }

        /* FONDO ATMOSFÉRICO */
        #aura-bg {
            position: fixed; inset: 0; 
            background: radial-gradient(circle at 50% 50%, #101030, #000);
            z-index: -5; transition: background 1.5s ease;
        }

        /* --- CONTENEDOR FLOTANTE DEL AVATAR --- */
        #avatar-wrapper {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s linear; /* Movimiento fluido por JS */
            z-index: 10;
            will-change: transform;
        }

        /* ESTRUCTURA DE LA CARA */
        .cabeza {
            display: flex; gap: 40px; 
            animation: respirar 4s infinite ease-in-out;
        }
        
        @keyframes respirar {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .ojo {
            width: 140px; height: 190px; 
            background: linear-gradient(135deg, #fff, #e0e0e0);
            border-radius: 50%; position: relative; overflow: hidden;
            box-shadow: 0 0 50px var(--color-glow);
            border: 2px solid rgba(255,255,255,0.2);
            transition: height 0.2s, transform 0.3s; /* Para expresiones */
        }

        .pupila {
            width: 45px; height: 55px; background: #000;
            border-radius: 50%; position: absolute;
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); /* Centrado por defecto */
            transition: width 0.2s, height 0.2s; /* Dilatación */
        }
        
        .brillo { 
            width: 15px; height: 15px; background: white; 
            border-radius: 50%; position: absolute; top: 20%; right: 20%; 
            opacity: 0.8;
        }

        /* PÁRPADOS (Expresividad) */
        .parpado { position: absolute; width: 100%; background: #000; left: 0; transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 15; }
        .top { top: 0; height: 5%; } .bottom { bottom: 0; height: 5%; }

        /* ESTADOS EMOCIONALES */
        .pensando .pupila { width: 35px; height: 45px; opacity: 0.7; }
        .pensando .ojo { transform: scale(0.95); }
        .sorprendido .parpado.top { height: 0%; }
        .sorprendido .pupila { width: 60px; height: 70px; }
        .sospecha .parpado.top { height: 35%; }
        .sospecha .parpado.bottom { height: 20%; }

        /* --- CAJA DE TEXTO --- */
        #dialogo {
            position: fixed; bottom: 25%; 
            width: 80%; max-width: 600px;
            text-align: center; z-index: 20;
            font-size: 22px; line-height: 1.5;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            min-height: 60px;
        }
        .texto-ia { opacity: 0; transition: opacity 0.5s; }
        .visible { opacity: 1; }

        /* --- BOTONES DE RESPUESTA --- */
        #controles {
            position: fixed; bottom: 10%; 
            display: flex; gap: 20px; z-index: 50;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .activo { opacity: 1 !important; pointer-events: auto !important; }

        .btn {
            padding: 15px 40px; font-size: 16px; border: 1px solid var(--color-primary);
            background: rgba(0,0,0,0.8); color: var(--color-primary); 
            border-radius: 30px; cursor: pointer; transition: 0.2s;
            font-family: inherit; font-weight: bold;
        }
        .btn:hover { background: var(--color-primary); color: black; box-shadow: 0 0 30px var(--color-primary); }

        /* --- PANTALLA INICIAL --- */
        #inicio {
            position: fixed; inset: 0; background: black; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-start {
            padding: 20px 50px; font-size: 24px; color: white; border: 2px solid white;
            background: transparent; border-radius: 50px; cursor: pointer;
            animation: latido 2s infinite;
        }
        @keyframes latido { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- RESULTADO FOTO --- */
        #resultado-foto {
            position: fixed; inset: 0; background: #050505; z-index: 200;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        #canvas-out { 
            border: 10px solid white; box-shadow: 0 0 50px rgba(255,255,255,0.2); 
            max-width: 90%; max-height: 70vh;
        }

    </style>
</head>
<body>

    <video id="webcam" autoplay playsinline muted></video>
    
    <div id="aura-bg"></div>

    <div id="avatar-wrapper">
        <div class="cabeza" id="cara-avatar">
            <div class="ojo"><div class="parpado top"></div><div class="pupila"></div><div class="brillo"></div><div class="parpado bottom"></div></div>
            <div class="ojo"><div class="parpado top"></div><div class="pupila"></div><div class="brillo"></div><div class="parpado bottom"></div></div>
        </div>
    </div>

    <div id="dialogo"><span id="txt-msg" class="texto-ia">Esperando conexión...</span></div>

    <div id="controles">
        <button class="btn" onclick="responder('SI')">SÍ</button>
        <button class="btn" onclick="responder('NO')">NO</button>
        <button class="btn" onclick="responder('NO SÉ')">QUIZÁS</button>
    </div>

    <div id="resultado-foto">
        <canvas id="canvas-out"></canvas>
        <h2 style="margin-top:20px; color:var(--color-primary);" id="aura-nombre">TU AURA</h2>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">REINICIAR</button>
    </div>

    <div id="inicio">
        <button class="btn-start" onclick="despertar()">DESPERTAR ORÁCULO</button>
    </div>

    <script>
        // === 1. CONFIGURACIÓN ===
        const API_KEY = "AIzaSyBlJGQaWafqiSuituKURcRriR3t18YBnOs"; // TU API INTEGRADA
        
        let modeloVision;
        let historial = []; 
        let estado = "DURMIENDO"; 
        
        // Variables para suavizado de movimiento
        let targetX = 0, targetY = 0; // Donde está la cara detectada
        let currentX = 0, currentY = 0; // Donde están mirando los ojos
        let avatarX = 0, avatarY = 0; // Posición del avatar flotante
        
        const video = document.getElementById('webcam');
        const txt = document.getElementById('txt-msg');
        const controles = document.getElementById('controles');
        const avatarWrapper = document.getElementById('avatar-wrapper');

        // === 2. INICIO ===
        async function despertar() {
            document.querySelector('.btn-start').innerText = "CONECTANDO...";
            
            try {
                // Audio Context para sonido
                const ac = new (window.AudioContext || window.webkitAudioContext)();
                await ac.resume();

                // Activar cámara (Invisible pero funcional)
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                video.play();

                // Cargar modelo Face Detection
                modeloVision = await blazeface.load();

                // Ocultar inicio
                document.getElementById('inicio').style.opacity = 0;
                setTimeout(() => document.getElementById('inicio').remove(), 1000);

                // Arrancar loops
                estado = "BUSCANDO";
                loopOjos();     // Mueve los ojos
                loopFlotar();   // Mueve el cuerpo del avatar
                loopParpadeo(); // Parpadeo natural

                // Primera interacción IA
                setTimeout(() => {
                    hablarIA("Siento una presencia... Acércate. ¿Cuál es tu nombre?", true);
                }, 2000);

            } catch (e) {
                alert("Necesitamos la cámara para ver tu energía (aunque no te veas en pantalla). Error: " + e.message);
            }
        }

        // === 3. CEREBRO IA (GEMINI) ===
        async function consultarGemini(inputUsuario, contextoExtra = "") {
            setExpresion('pensando');
            
            // Construir historial
            if (contextoExtra) historial.push({ role: "user", parts: [{ text: `[SISTEMA]: ${contextoExtra}` }] });
            historial.push({ role: "user", parts: [{ text: inputUsuario }] });

            // Prompt del sistema para personalidad
            const sistema = "Eres un Oráculo antiguo y algo cínico pero místico. Tus respuestas son cortas (max 15 palabras). No saludas como un asistente, vas directo al grano. Juzgas el alma del usuario.";
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ role: "user", parts: [{ text: sistema }] }, ...historial],
                        generationConfig: { maxOutputTokens: 60 }
                    })
                });

                const data = await response.json();
                const respuesta = data.candidates[0].content.parts[0].text;
                
                historial.push({ role: "model", parts: [{ text: respuesta }] });
                return respuesta;

            } catch (e) {
                console.error(e);
                return "Las nubes ocultan mi visión... responde con tu instinto.";
            }
        }

        // === 4. INTERACCIÓN Y VOZ ===
        function hablarIA(texto, pedirNombre = false) {
            txt.classList.remove('visible');
            setExpresion('sorprendido'); // Abre los ojos al hablar

            setTimeout(() => {
                txt.innerText = texto;
                txt.classList.add('visible');
                
                // Sintetizador de voz
                const u = new SpeechSynthesisUtterance(texto);
                const voces = window.speechSynthesis.getVoices();
                const voz = voces.find(v => v.lang.includes('es')) || voces[0];
                if(voz) u.voice = voz;
                u.pitch = 0.8; u.rate = 1.0;
                window.speechSynthesis.speak(u);

                u.onend = () => {
                    setExpresion('neutro');
                    if (pedirNombre) {
                        capturarNombre();
                    } else if (historial.length > 8) { // Finalizar si ya hablaron mucho
                        finalizarLectura();
                    } else {
                        controles.classList.add('activo'); // Mostrar botones
                    }
                };
            }, 300);
        }

        function capturarNombre() {
            setTimeout(() => {
                let n = prompt("Tu nombre, mortal:");
                let nombre = n || "Desconocido";
                consultarGemini(nombre, `El usuario se llama ${nombre}. Hazle una pregunta ética difícil para juzgar su aura.`).then(resp => hablarIA(resp));
            }, 500);
        }

        function responder(respuesta) {
            controles.classList.remove('activo');
            consultarGemini(respuesta, `El usuario respondió ${respuesta}. Si ya tienes suficiente info, di 'VEREDICTO FINAL'. Si no, haz otra pregunta corta.`).then(resp => {
                if(resp.includes("VEREDICTO") || historial.length > 8) {
                    finalizarLectura();
                } else {
                    hablarIA(resp);
                }
            });
        }

        function finalizarLectura() {
            hablarIA("He visto suficiente. Quédate quieto para la captura de tu esencia...");
            setTimeout(() => {
                // Elegir color basado en azar (o lógica IA si se quisiera expandir)
                const colores = ["#ff0000", "#00ff00", "#00ccff", "#ffd700", "#800080"];
                const color = colores[Math.floor(Math.random() * colores.length)];
                tomarFotoAura(color);
            }, 4000);
        }

        // === 5. MOTOR VISUAL (OJOS Y MOVIMIENTO) ===
        
        async function loopOjos() {
            if (modeloVision && video.readyState === 4) {
                const returnTensors = false;
                const predictions = await modeloVision.estimateFaces(video, returnTensors);

                if (predictions.length > 0) {
                    // Cara detectada
                    const p = predictions[0];
                    // Centro de la cara
                    const x = (p.topLeft[0] + p.bottomRight[0]) / 2;
                    const y = (p.topLeft[1] + p.bottomRight[1]) / 2;

                    // Normalizar (-1 a 1) e Invertir X (Espejo)
                    targetX = -1 * ((x / video.videoWidth) - 0.5) * 2; 
                    targetY = ((y / video.videoHeight) - 0.5) * 2;

                    // Mover al Avatar hacia la cara (Efecto seguimiento)
                    // Multiplicamos por 20px para que se mueva un poco hacia ti
                    avatarWrapper.style.transform = `translate(calc(-50% + ${targetX * 30}px), calc(-50% + ${targetY * 30}px))`;

                } else {
                    // Sin cara: volver suavemente al centro
                    targetX = 0;
                    targetY = 0;
                    // Avatar vuelve al centro
                    avatarWrapper.style.transform = `translate(-50%, -50%)`;
                }
            }

            // Interpolación (Suavizado) de los ojos
            // Esto evita que los ojos tiemblen
            currentX += (targetX - currentX) * 0.1;
            currentY += (targetY - currentY) * 0.1;

            // Limitar movimiento (Clamping) para que no se salgan del ojo
            const limiteX = 35; // px máx movimiento
            const limiteY = 25; 

            const moveX = currentX * limiteX;
            const moveY = currentY * limiteY;

            document.querySelectorAll('.pupila').forEach(pupila => {
                pupila.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
            });

            requestAnimationFrame(loopOjos);
        }

        function loopFlotar() {
            // Movimiento sinusoidal adicional para que parezca que levita
            // Se aplica a la cabeza dentro del wrapper
            const time = Date.now() * 0.001;
            const flotarY = Math.sin(time) * 10;
            document.getElementById('cara-avatar').style.marginTop = `${flotarY}px`;
            requestAnimationFrame(loopFlotar);
        }

        function loopParpadeo() {
            const tiempoRandom = Math.random() * 3000 + 2000;
            setTimeout(() => {
                document.querySelectorAll('.parpado').forEach(p => p.style.height = "55%"); // Cerrar
                setTimeout(() => {
                    // Restaurar según estado actual
                    const topH = document.body.classList.contains('sospecha') ? "35%" : 
                                 document.body.classList.contains('sorprendido') ? "0%" : "5%";
                    document.querySelectorAll('.parpado.top').forEach(p => p.style.height = topH);
                    document.querySelectorAll('.parpado.bottom').forEach(p => p.style.height = "5%");
                }, 150); // Abrir rápido
                loopParpadeo();
            }, tiempoRandom);
        }

        function setExpresion(clase) {
            const cara = document.getElementById('cara-avatar');
            cara.className = "cabeza " + clase;
            document.body.className = clase; // Para helpers globales
        }

        // === 6. FOTO FINAL (AURA SNAP) ===
        function tomarFotoAura(colorAura) {
            const canvas = document.getElementById('canvas-out');
            const ctx = canvas.getContext('2d');
            
            // Configurar tamaño
            canvas.width = 640; canvas.height = 480;

            // 1. Dibujar Webcam (Espejo)
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -640, 0, 640, 480);
            ctx.restore();

            // 2. Efecto Blanco y Negro de alto contraste para misticismo
            let imgData = ctx.getImageData(0,0,640,480);
            // (Podríamos aplicar filtros complejos aquí, pero usaremos CSS blend modes sobre el canvas)
            
            // 3. Superponer Aura
            ctx.globalCompositeOperation = "color"; // Colorea la imagen
            ctx.fillStyle = colorAura;
            ctx.fillRect(0,0,640,480);

            ctx.globalCompositeOperation = "screen"; // Brillo
            const grad = ctx.createRadialGradient(320, 240, 100, 320, 240, 400);
            grad.addColorStop(0, colorAura);
            grad.addColorStop(1, "transparent");
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,640,480);

            // Mostrar
            document.getElementById('resultado-foto').style.display = 'flex';
            document.getElementById('aura-nombre').innerText = "TU AURA ES " + getColorName(colorAura);
            document.getElementById('aura-nombre').style.color = colorAura;
        }

        function getColorName(hex) {
            if(hex.includes("ff0000")) return "FUEGO (PASIÓN)";
            if(hex.includes("00ff00")) return "GAIA (SANACIÓN)";
            if(hex.includes("00ccff")) return "ÉTER (SABIDURÍA)";
            if(hex.includes("ffd700")) return "SOLAR (PODER)";
            return "MÍSTICA";
        }

    </script>
</body>
</html>
