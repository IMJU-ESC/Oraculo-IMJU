<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cupido IMJU Escuinapa - V15 Mega Pack</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Bangers&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILO GENERAL --- */
        :root { --imju-pink: #ff006e; --imju-purple: #8338ec; --imju-orange: #fb5607; }
        
        body {
            margin: 0; height: 100vh; overflow: hidden; font-family: 'Fredoka', sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #8338ec, #ff006e, #fb5607);
            background-size: 300% 300%;
            animation: fondoEscuinapa 15s ease infinite;
            color: white;
            user-select: none;
        }
        @keyframes fondoEscuinapa {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* EMOJIS FLOTANTES */
        .emoji-float {
            position: absolute; bottom: -50px; font-size: 2.5rem; opacity: 0.2;
            animation: subir 9s linear infinite; pointer-events: none; z-index: 0;
        }
        @keyframes subir {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; }
        }

        #webcam { position: fixed; top: 0; left: 0; visibility: hidden; pointer-events: none; }

        /* --- HEADER --- */
        #header-imju {
            position: fixed; top: 20px; text-align: center; z-index: 50;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.15);
        }
        #header-imju h1 { margin: 0; font-family: 'Bangers', cursive; font-size: 4rem; letter-spacing: 2px; color: white; }
        #header-imju p { margin: 0; font-size: 1.4rem; font-weight: bold; background: rgba(255,255,255,0.2); padding: 5px 20px; border-radius: 30px; display: inline-block; }

        /* --- AVATAR GIGANTE --- */
        #avatar-container { 
            position: relative; width: 550px; height: 450px;
            z-index: 10; margin-bottom: 10px; margin-top: 60px;
        }
        
        #cabeza {
            width: 100%; height: 100%; background: transparent; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; animation: flotar 5s ease-in-out infinite;
        }
        @keyframes flotar { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .faccion-sombra { filter: drop-shadow(0 8px 4px rgba(0,0,0,0.2)); }

        /* Cejas */
        .cejas-row { display: flex; gap: 140px; position: absolute; top: 30px; width: 100%; justify-content: center; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .ceja { width: 110px; height: 28px; background: white; border-radius: 30px; transition: 0.3s; }

        /* Ojos */
        .ojos-row { display: flex; gap: 60px; margin-top: 60px; z-index: 2; }
        .ojo-wrapper {
            width: 150px; height: 150px; 
            position: relative; overflow: hidden; border-radius: 50%;
            background: white; border: 6px solid rgba(0,0,0,0.05); transition: 0.3s;
        }
        .pupila { 
            width: 70px; height: 70px; background: #222; border-radius: 50%; 
            position: absolute; top: 26%; left: 26%; transition: 0.1s;
        }
        .brillo {
            width: 30px; height: 30px; background: white; border-radius: 50%;
            position: absolute; top: 25px; right: 30px; opacity: 0.9;
        }
        
        /* Boca */
        .boca { 
            width: 80px; height: 25px; background: white; border-radius: 30px; 
            margin-top: 70px; transition: 0.3s; 
        }

        /* --- EXPRESIONES --- */
        .hablando .boca { width: 100px; height: 70px; border-radius: 40% 40% 50% 50%; animation: hablarAnim 0.2s infinite alternate; }
        .hablando .ceja { animation: cejasHablando 0.5s infinite alternate; }
        @keyframes hablarAnim { from { height: 30px; transform: scaleY(0.8); } to { height: 70px; transform: scaleY(1); } }
        @keyframes cejasHablando { from { transform: translateY(0); } to { transform: translateY(-5px); } }

        .sospecha .ceja:first-child { transform: rotate(15deg) translateY(10px); }
        .sospecha .ceja:last-child { transform: rotate(-15deg) translateY(-20px); }
        .sospecha .ojo-wrapper { height: 120px; border-radius: 40%; margin-top: 15px; }
        .sospecha .boca { width: 60px; transform: translateX(10px) rotate(-5deg); }

        .sorpresa .ceja { transform: translateY(-50px) scaleX(1.1); }
        .sorpresa .ojo-wrapper { transform: scale(1.15); border-color: #ff006e; }
        .sorpresa .boca { width: 70px; height: 70px; border-radius: 50%; margin-top: 80px; }

        .feliz .ojo-wrapper { height: 80px; margin-top: 35px; border-radius: 10px 10px 100px 100px; }
        .feliz .boca { width: 110px; height: 50px; border-radius: 10px 10px 100px 100px; margin-top: 60px; }
        .feliz .ceja { transform: translateY(-10px); }

        .enamorado .ojo-wrapper { background: #ff006e; }
        .enamorado .pupila, .enamorado .brillo { opacity: 0; }
        .enamorado .ojo-wrapper::after { content:'üòç'; font-size:100px; position:absolute; top:20px; left:25px; animation: latido 0.8s infinite; }

        /* --- UI TEXTO --- */
        #texto-globo {
            background: white; color: #222; padding: 25px 40px;
            border-radius: 50px; font-size: 1.8rem; text-align: center; max-width: 90%;
            box-shadow: 0 15px 0 rgba(0,0,0,0.1); font-weight: bold; margin-bottom: 20px;
            min-height: 100px; display: flex; align-items: center; justify-content: center;
            border: 6px solid white; transform: scale(0.9); opacity: 0; transition: 0.4s;
            position: relative; z-index: 20;
        }
        #texto-globo.visible { transform: scale(1); opacity: 1; }
        #texto-globo.alerta { color: #ff006e; }

        /* --- BOTONES --- */
        #botones-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; width: 95%; z-index: 20; }
        .btn {
            padding: 25px 45px; font-size: 1.6rem; border: none; border-radius: 60px;
            cursor: pointer; font-family: 'Fredoka', sans-serif; font-weight: bold;
            transition: 0.1s; box-shadow: 0 10px 0 rgba(0,0,0,0.2); opacity: 0; transform: translateY(30px);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn.show { opacity: 1; transform: translateY(0); }
        .btn:active { transform: translateY(10px); box-shadow: 0 0 0; }
        .btn-a { background: white; color: #ff006e; }
        .btn-b { background: #3a86ff; color: white; }

        /* SENSOR */
        #sensor-area { display: none; flex-direction: column; align-items: center; margin-top: 10px; z-index: 20; }
        #fingerprint {
            font-size: 6rem; width: 160px; height: 160px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: 8px dashed white; display: flex;
            align-items: center; justify-content: center; cursor: pointer; animation: pulse 1.5s infinite;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #fingerprint.active { background: #fff; color:#ff006e; border-style: solid; animation: none; transform: scale(0.95); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: 0 0 0 30px rgba(255,255,255,0); } }

        /* MODAL FINAL */
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 5000; flex-direction:column; align-items:center; justify-content:center; }
        #polaroid { background: white; padding: 25px 25px 60px 25px; transform: rotate(-2deg); box-shadow: 0 0 80px rgba(255,0,110,0.6); text-align: center; max-width: 85%; border-radius: 10px; }
        #foto-result { width: 100%; max-width: 500px; border: 2px solid #eee; display: block; }
        #frase-final { font-family: 'Fredoka', sans-serif; color: #ff006e; font-size: 1.5rem; margin-top: 20px; font-weight: bold; line-height: 1.3; }
        #timer-reset { position: absolute; top: 10px; right: 20px; color: white; font-size: 1.5rem; font-weight: bold; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; }

        #start-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg, #ff006e, #8338ec); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="emoji-layer"></div>

    <div id="start-screen">
        <h1 style="font-family: 'Bangers', cursive; font-size: 6rem; margin-bottom: 10px; text-shadow: 5px 5px 0px #000;">CUPIDO IMJU</h1>
        <h2 style="font-size: 2rem; margin-top: 0; opacity: 1;">ESCUINAPA üç§üö≤</h2>
        <p style="font-size: 1.8rem; margin-bottom: 10px; font-weight: bold;">¬°J√°lense plebes!</p>
        <p style="font-size: 1.4rem; margin-bottom: 40px; opacity: 0.9;">¬øHay futuro o nel? ¬°Vengan a descubrir su suerte!</p>
        <button class="btn btn-a show" id="btn-init" onclick="iniciarApp()" disabled>Iniciando Sistema...</button>
    </div>

    <div id="header-imju">
        <h1>IMJU ESCUINAPA</h1>
        <p>Juventud que Transforma</p>
    </div>

    <video id="webcam" autoplay playsinline muted></video>

    <div id="avatar-container">
        <div id="cabeza">
            <div class="cejas-row faccion-sombra"><div class="ceja"></div><div class="ceja"></div></div>
            <div class="ojos-row faccion-sombra">
                <div class="ojo-wrapper"><div class="pupila"></div><div class="brillo"></div></div>
                <div class="ojo-wrapper"><div class="pupila"></div><div class="brillo"></div></div>
            </div>
            <div class="boca faccion-sombra"></div>
        </div>
    </div>

    <div id="texto-globo">Esperando a la raza...</div>

    <div id="botones-container"></div>

    <div id="sensor-area">
        <div id="fingerprint" onmousedown="scanStart()" onmouseup="scanEnd()" ontouchstart="scanStart()" ontouchend="scanEnd()">üíñ</div>
        <p id="sensor-instruccion" style="font-weight:bold; margin-top:25px; font-size: 1.5rem; text-shadow: 0 2px 4px black;">MANT√âN PULSADO</p>
    </div>

    <div id="modal">
        <div id="timer-reset">Reiniciando en 20s...</div>
        <div id="polaroid">
            <img id="foto-result" src="">
            <div id="frase-final">An√°lisis...</div>
        </div>
        <div style="margin-top:20px; display:flex; gap:20px;">
            <button class="btn btn-b show" onclick="descargar()">GUARDAR FOTO</button>
            <button class="btn btn-a show" onclick="location.reload()">REINICIAR YA</button>
        </div>
    </div>

    <script>
        // --- VOZ ---
        let vozSeleccionada = null;
        window.speechSynthesis.onvoiceschanged = () => {
            const voces = window.speechSynthesis.getVoices();
            vozSeleccionada = voces.find(v => v.name.includes('Google') && v.lang.includes('es')) || 
                              voces.find(v => v.lang === 'es-MX') || 
                              voces.find(v => v.lang.includes('es'));
        };

        // --- EMOJIS ---
        function crearEmojisFondo() {
            const emojis = ['üç§', 'üö≤', 'ü•≠', 'üå¥', '‚ù§Ô∏è', 'üåÆ', 'üåä', '‚òÄÔ∏è', 'üíñ', 'üéµ'];
            const container = document.getElementById('emoji-layer');
            setInterval(() => {
                const el = document.createElement('div');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.className = 'emoji-float';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.animationDuration = (Math.random() * 5 + 8) + 's';
                container.appendChild(el);
                setTimeout(() => el.remove(), 11000);
            }, 800);
        }
        crearEmojisFondo();

        // --- BASE DE DATOS MASIVA (MEGA PACK) ---
        const DB = {
            SOLO: {
                intro: [
                    "¬°Qu√© rollo! ¬øVienes solo? A toda madre, mejor solo que mal acompa√±ado.",
                    "¬°Epa! Te veo muy solito pariente. A ver qu√© dice la suerte.",
                    "¬øSoltero? ¬°Fierro! Tienes m√°s tiempo para la bici y los tamales.",
                    "Vienes a probar suerte, eso me gusta. A ver si sales con novia/o hoy."
                ],
                preguntas: [
                    { q: "¬øQu√© prefieres el fin de semana?", a: "Malec√≥n y relax üåä", b: "Fiesta y banda ü•Å", rA: "Tranquil√≥n, me gusta.", rB: "¬°Fiestero el plebe!" },
                    { q: "¬øQu√© buscas en una pareja?", a: "Lealtad ante todo ü§ù", b: "Que me haga re√≠r üòÇ", rA: "La base de todo.", rB: "Risa es igual a amor." },
                    { q: "¬øBicicleta o Moto?", a: "Pura Bici üö≤", b: "Moto üèçÔ∏è", rA: "¬°Puro deporte local!", rB: "Con casco eh, pariente." },
                    { q: "¬øCenar√≠as tamales barbudos en la primera cita?", a: "¬°Claro que s√≠! ü´î", b: "Mejor algo fresa üçì", rA: "Eso es orgullo culichi.", rB: "Uy, qu√© delicado." },
                    { q: "¬øPerdonar√≠as una infidelidad?", a: "Jam√°s üö´", b: "Tal vez... ü§î", rA: "Dignidad al 100.", rB: "No lo haga compa." },
                    { q: "¬øTe gusta el calor de aqu√≠?", a: "Lo amo ‚òÄÔ∏è", b: "Lo odio ü•µ", rA: "Team Calor, eso es todo.", rB: "Ponte en el aire pues." },
                    { q: "¬øIr√≠as a Las Cabras con tu ex?", a: "Ni loco/a", b: "Si paga todo, s√≠", rA: "Sabia decisi√≥n.", rB: "El inter√©s tiene pies." },
                    { q: "¬øEres celoso/a?", a: "Un poquito ü§è", b: "Cero celos üòé", rA: "Poquito es normal.", rB: "Qu√© seguridad te cargas." },
                    { q: "¬øCrees en el amor a primera vista?", a: "Sim√≥n üòç", b: "Puro cuento", rA: "Ay, qu√© rom√°ntico.", rB: "Directo y realista." },
                    { q: "¬øAguachile verde o rojo?", a: "Verde üå∂Ô∏è", b: "Rojo (tranqui)", rA: "Te gusta sufrir, ¬°bien!", rB: "Pa' no enchilarse." },
                    { q: "¬øStalkeas a tu crush?", a: "Investigador FBI üïµÔ∏è", b: "Nel, qu√© flojera", rA: "Cuidado con el dedo resbaloso.", rB: "Muy maduro de tu parte." },
                    { q: "¬øQui√©n da el primer paso?", a: "Yo mero üòé", b: "Que me busquen", rA: "Actitud ganadora.", rB: "A esperar sentado entonces." },
                    { q: "¬øBanda o Reggaeton?", a: "La Tambora üé∫", b: "Perreo intenso", rA: "¬°Arriba la banda!", rB: "Hasta el suelo pariente." },
                    { q: "¬øTe quieres casar alg√∫n d√≠a?", a: "S√≠, boda grande üíç", b: "Mejor viajar ‚úàÔ∏è", rA: "Ahorra para el pachang√≥n.", rB: "Esp√≠ritu libre." },
                    { q: "¬øEres de los que lloran con pelis?", a: "Un mar de l√°grimas üò≠", b: "Coraz√≥n de piedra üóø", rA: "Qu√© sentimental.", rB: "Duro de matar." },
                    { q: "¬øTe gusta que te regalen flores?", a: "Me encantan üåπ", b: "Mejor comida üåÆ", rA: "Cl√°sico y bonito.", rB: "Amor con hambre no dura." }
                ],
                resultados: [
                    { t: "Soltero de Oro", d: "Eres un partidazo. Disfruta tu libertad, el amor llegar√° cuando menos lo esperes. Mientras, ¬°vete por unos tacos!" },
                    { t: "Rom√°ntico Empedernido", d: "Tienes mucho amor para dar. No te desesperes, esa persona especial anda perdida en Teacap√°n, pero ya viene." },
                    { t: "Alma Libre", d: "Tu vibra es de libertad total. No necesitas a nadie para ser feliz, ¬°y eso se nota! Sigue brillando." },
                    { t: "El Inalcanzable", d: "Traes los est√°ndares muy altos. Est√° bien, no te conformes con menos de lo que mereces, pariente." },
                    { t: "Coraz√≥n Blindado", d: "Te haces el duro, pero en el fondo eres bien tierno. D√©jate querer un poquito, no pasa nada." },
                    { t: "Aventurero Solitario", d: "Lo tuyo es explorar y vivir al d√≠a. El amor te encontrar√° en una de tus aventuras, no lo busques." }
                ]
            },
            PAREJA: {
                intro: [
                    "¬°Pareja a la vista! Ojo: Que conteste solo uno de ustedes, p√≥nganse de acuerdo.",
                    "Se ven bien juntos. Pero solo uno pique los botones, no se peleen.",
                    "¬°Ay el amor! Vamos a ver si duran hasta las pr√≥ximas fiestas del mar."
                ],
                preguntas: [
                    { q: "¬øQui√©n invita los camarones?", a: "√âl/Ella siempre üç§", b: "Vamos micha y micha", rA: "¬°Cu√≠dalo/a, vale oro!", rB: "Parejos, muy bien." },
                    { q: "¬øQui√©n se enoja m√°s r√°pido?", a: "√âl/Ella üò°", b: "Yo mero üòí", rA: "Paciencia pariente.", rB: "B√°jale al drama." },
                    { q: "¬øQui√©n maneja mejor la bici?", a: "√âl/Ella es pro üö≤", b: "Yo soy mejor", rA: "¬°Talento local!", rB: "Hagan carreritas." },
                    { q: "¬øQui√©n olvida las fechas importantes?", a: "√âl/Ella üìÖ", b: "Yo, mala memoria", rA: "¬°P√≥nganle alarma!", rB: "Te va a tocar castigo." },
                    { q: "¬øSe revisar√≠an el celular?", a: "Nel, confianza ü§ù", b: "Pr√©stalo pa'ca üëÄ", rA: "Eso es amor sano.", rB: "¬°Se va a armar!" },
                    { q: "¬øDomingo ideal?", a: "Ver pelis üé¨", b: "Salir a dar la vuelta", rA: "Acurrucaditos mejor.", rB: "A lucirse al malec√≥n." },
                    { q: "¬øQui√©n cocina m√°s rico?", a: "√âl/Ella üç≥", b: "Yo soy Chef", rA: "El amor entra por la panza.", rB: "Inviten a cenar pues." },
                    { q: "¬øQui√©n es m√°s cari√±oso?", a: "√âl/Ella ü•∞", b: "Yo soy un bomb√≥n", rA: "Qu√© bonito es lo bonito.", rB: "Pura miel derraman." },
                    { q: "¬øQui√©n se duerme en las pel√≠culas?", a: "√âl/Ella ronca üò¥", b: "Yo caigo frito", rA: "Qu√© aburridos, jaja.", rB: "Te perdiste el final." },
                    { q: "¬øC√≥mo se llevan con los suegros?", a: "Soy el consentido üòá", b: "Me hacen caras üò†", rA: "Ya la hiciste.", rB: "G√°natelos con tamales." },
                    { q: "¬øBesos en p√∫blico?", a: "S√≠, mucho amor üòò", b: "Me da pena üò≥", rA: "¬°Que viva el amor!", rB: "Respetables, muy bien." },
                    { q: "¬øQui√©n tarda m√°s arregl√°ndose?", a: "√âl/Ella uff ‚è≥", b: "Yo soy lento", rA: "La belleza cuesta tiempo.", rB: "Paciencia, mucha paciencia." },
                    { q: "¬øQui√©n gana en las peleas?", a: "√âl/Ella siempre", b: "Yo nunca pierdo", rA: "Mandil√≥n pero feliz.", rB: "Qu√© car√°cter te cargas." },
                    { q: "¬øAhorrar o Gastar?", a: "Ahorrar pa'l futuro üí∞", b: "Vivir el momento üí∏", rA: "Mente de tibur√≥n.", rB: "¬°Disfruten, que se acaba!" },
                    { q: "¬øHijos o Mascotas?", a: "Beb√©s üë∂", b: "Perrhijos üê∂", rA: "A comprar pa√±ales.", rB: "A comprar croquetas." },
                    { q: "¬øPlaya o Rancho?", a: "Playa y sol üèñÔ∏è", b: "Rancho y caballos üêé", rA: "A broncearse.", rB: "¬°Fierro pariente!" }
                ],
                resultados: [
                    { t: "Amor del Bueno", d: "Se nota que se quieren un chorro. Tienen una conexi√≥n b√°rbara, sigan as√≠ de unidos y leales." },
                    { t: "Pareja Dinamita", d: "Son pura energ√≠a juntos. A veces chocan, pero es porque se aman con intensidad. ¬°B√°jenle al drama y s√∫banle al amor!" },
                    { t: "Equipo Perfecto", d: "Se complementan como el mango y el chamoy. Lo que le falta a uno, lo tiene el otro. ¬°Felicidades plebes!" },
                    { t: "Almas Gemelas", d: "Est√°n hechos el uno para el otro. Su destino es estar juntos, hasta viejitos en la mecedora." },
                    { t: "Polos Opuestos", d: "Son muy diferentes, pero eso es lo divertido. Uno pone la calma y el otro el desorden. ¬°Funcionan incre√≠ble!" },
                    { t: "Pareja de Telenovela", d: "Mucho drama, mucha pasi√≥n y mucho amor. Nunca se aburren, pero aguas con los celos, eh." }
                ]
            },
            AMIGOS: {
                intro: [
                    "¬°Puro compa aqu√≠! Ojo: Uno responde, el otro apoya. Lealtad ante todo.",
                    "La clika de Escuinapa. Decidan qui√©n va a picarle a la pantalla.",
                    "A ver qui√©n es el l√≠der de la manada. Solo uno responde."
                ],
                preguntas: [
                    { q: "¬øQui√©n baila mejor?", a: "Mi compa üíÉ", b: "Yo, obvio", rA: "¬°A sacar los prohibidos!", rB: "El alma de la fiesta." },
                    { q: "¬øQui√©n debe dinero?", a: "Yo le debo üôà", b: "Me debe feria üò†", rA: "Paga los 20 pesos.", rB: "C√≥brale con intereses." },
                    { q: "¬øQui√©n llega tarde?", a: "Mi compa üê¢", b: "Yo, la neta", rA: "Reg√°lale un reloj.", rB: "La puntualidad es clave." },
                    { q: "¬øGuardar√≠an un secreto grave?", a: "A la tumba ‚ö∞Ô∏è", b: "Se me escapa üôä", rA: "Lealtad pura.", rB: "Aguas contigo." },
                    { q: "¬øQui√©n es m√°s probable que acabe preso?", a: "Mi compa üöì", b: "Yo soy el caos", rA: "¬°C√≥rrele!", rB: "Mala influencia." },
                    { q: "¬øQui√©n picha la cena hoy?", a: "Este compa üçî", b: "Yo invito", rA: "¬°Ese es amigo!", rB: "Qu√© generoso." },
                    { q: "¬øSe han peleado por un amor?", a: "Jam√°s üö´", b: "Una vez... üíî", rA: "La amistad es primero.", rB: "Eso no se hace." },
                    { q: "¬øQui√©n se enamora de cualquiera?", a: "Mi compa üòç", b: "Yo soy f√°cil", rA: "Coraz√≥n de condominio.", rB: "Enamorado del amor." },
                    { q: "¬øQui√©n come m√°s?", a: "Barril sin fondo üåÆ", b: "Comemos igual", rA: "Sale caro invitarlo.", rB: "Buen diente." },
                    { q: "¬øQui√©n es el m√°s chismoso?", a: "Mi compa sabe todo üïµÔ∏è", b: "Yo soy comunicativo", rA: "Ventaneando le dicen.", rB: "Informaci√≥n es poder." },
                    { q: "¬øQui√©n aguanta m√°s despierto?", a: "B√∫ho nocturno ü¶â", b: "Se duerme temprano", rA: "¬°Fiesta hasta el amanecer!", rB: "Ya est√° viejito/a." },
                    { q: "¬øSe prestan ropa?", a: "Todo el tiempo üëï", b: "Gu√°cala no", rA: "Eso es confianza.", rB: "Cada quien sus trapos." },
                    { q: "¬øQui√©n maneja mejor?", a: "Mi compa es piloto üèéÔ∏è", b: "Yo manejo mejor", rA: "Seguridad ante todo.", rB: "¬°Fierro por la costera!" },
                    { q: "¬øQui√©n llora m√°s f√°cil?", a: "Mi compa es chill√≥n üò¢", b: "Yo soy de l√°grima", rA: "Hay que darle un abrazo.", rB: "Sentimientos a flor de piel." },
                    { q: "¬øIr√≠an juntos de viaje?", a: "¬°Ya tenemos maletas! ‚úàÔ∏è", b: "Nos matamos antes", rA: "¬°V√°monos!", rB: "Mejor de lejitos." }
                ],
                resultados: [
                    { t: "Compas de Acero", d: "Esta amistad es a prueba de balas. Pase lo que pase, siempre se van a respaldar. ¬°Eso es lealtad!" },
                    { t: "El D√∫o Din√°mico", d: "Juntos son un desorden, pero del bueno. Son la alegr√≠a de la fiesta y el terror de los vecinos." },
                    { t: "Hermanos de Otra Madre", d: "Lo de ustedes no es amistad, es hermandad. Se conocen todos los secretos y aun as√≠ se quieren." },
                    { t: "Socios del Crimen", d: "Cuidado con ustedes dos juntos. Tienen una complicidad √∫nica, ¬°nunca cambien esa vibra!" },
                    { t: "Amigos de Parranda", d: "Ustedes nom√°s se juntan y ya tienen sed. Son divertidos, pero cu√≠dense el uno al otro, plebes." },
                    { t: "Los Inseparables", d: "Donde va uno, va el otro. Parecen chicles. Es una amistad bonita de esas que duran toda la vida." }
                ]
            }
        };

        // VARIABLES
        let model, video, trackingReq;
        let currentMode = null, questionQueue = [], qIndex = 0, isSpeaking = false;
        const textBubble = document.getElementById('texto-globo');
        const btnContainer = document.getElementById('botones-container');
        const sensorInstruccion = document.getElementById('sensor-instruccion');
        const NUM_PREGUNTAS = 5; // Cuestionario de 5

        // INICIO
        async function setup() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video = document.getElementById('webcam');
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                model = await blazeface.load();
                document.getElementById('btn-init').innerText = "¬°DALE GAS!";
                document.getElementById('btn-init').disabled = false;
            } catch(e) { alert("Activa la c√°mara pariente, es necesario."); }
        }
        setup();

        function iniciarApp() {
            document.getElementById('start-screen').style.display = 'none';
            loopOjos(); 
            setEmocion('sospecha');
            hablar("¬°Qu√© rollo plebes! Soy el Cupido del I.M.J.U. Escuinapa. Vengo a leer sus vibras.", () => {
                setTimeout(preguntarModo, 1000);
            });
        }

        // L√ìGICA DE JUEGO
        function preguntarModo() {
            setEmocion('sorpresa');
            mostrarTexto("¬øQui√©n anda ah√≠?");
            mostrarBotones([
                { txt: "Ando Solo/a ü§†", val: "SOLO" },
                { txt: "Somos Pareja ‚ù§Ô∏è", val: "PAREJA" },
                { txt: "Somos Amigos ‚úåÔ∏è", val: "AMIGOS" }
            ]);
        }

        function handleSeleccion(val) {
            if (["SOLO", "PAREJA", "AMIGOS"].includes(val)) {
                currentMode = val;
                prepararJuego();
            } else if (val === "A" || val === "B") handleRespuesta(val);
        }

        function prepararJuego() {
            const data = DB[currentMode];
            // REVUELVE Y TOMA 5 PREGUNTAS
            questionQueue = [...data.preguntas].sort(() => 0.5 - Math.random()).slice(0, NUM_PREGUNTAS);
            qIndex = 0;
            const introRandom = data.intro[Math.floor(Math.random() * data.intro.length)];
            setEmocion('hablando');
            hablar(introRandom, siguientePregunta);
        }

        function siguientePregunta() {
            if (qIndex >= questionQueue.length) { faseSensor(); return; }
            const q = questionQueue[qIndex];
            setEmocion('sospecha');
            setTimeout(() => {
                setEmocion('normal');
                mostrarTexto(q.q);
                hablar(q.q, () => { 
                    setTimeout(() => {
                        mostrarBotones([{ txt: q.a, val: "A" }, { txt: q.b, val: "B" }]);
                    }, 800);
                });
            }, 1000);
        }

        function handleRespuesta(opcion) {
            const q = questionQueue[qIndex];
            const reaccion = opcion === "A" ? q.rA : q.rB;
            
            if (reaccion.includes("!")) setEmocion('sorpresa'); 
            else if (reaccion.includes("amor") || reaccion.includes("bonito") || reaccion.includes("bien")) setEmocion('feliz');
            else setEmocion('hablando');
            
            mostrarTexto(reaccion);
            hablar(reaccion, () => {
                qIndex++;
                siguientePregunta();
            });
        }

        // SENSOR
        function faseSensor() {
            setEmocion('sospecha');
            const txt = currentMode === "SOLO" ? "Pon tu dedo y no lo sueltes." : "Pongan los dedos juntos y mantengan presionado.";
            mostrarTexto("¬°Hora de la verdad!");
            hablar(txt, () => {
                btnContainer.innerHTML = "";
                document.getElementById('sensor-area').style.display = 'flex';
            });
        }

        let sensorTimer;
        let sensorCompleto = false;

        function scanStart() {
            if(sensorCompleto) return;
            const f = document.getElementById('fingerprint');
            f.classList.add('active');
            
            sensorInstruccion.innerText = "¬°NO SUELTES!";
            sensorInstruccion.style.color = "#ffbe0b";
            mostrarTexto("LEYENDO VIBRAS...");
            playSonido(200, 400, 0.5);

            sensorTimer = setTimeout(() => {
                sensorCompleto = true;
                exitoSensor();
            }, 3000);
        }

        function scanEnd() {
            if(sensorCompleto) return;
            const f = document.getElementById('fingerprint');
            f.classList.remove('active');
            clearTimeout(sensorTimer);
            
            sensorInstruccion.innerText = "¬°TE DIJE QUE NO SOLTARAS!";
            sensorInstruccion.style.color = "white";
            textBubble.classList.add('alerta');
            mostrarTexto("¬°Ey! ¬°Sin miedo! D√©jalo puesto.");
            playSonido(150, 100, 0.3);
            setEmocion('sospecha');
            
            setTimeout(() => {
                textBubble.classList.remove('alerta');
                sensorInstruccion.innerText = "INTENTA OTRA VEZ";
            }, 1500);
        }

        function exitoSensor() {
            document.getElementById('sensor-area').style.display = 'none';
            setEmocion('enamorado');
            playSonido(600, 1200, 1.0);
            
            const resultadosPosibles = DB[currentMode].resultados;
            const res = resultadosPosibles[Math.floor(Math.random() * resultadosPosibles.length)];
            
            mostrarTexto("¬°AN√ÅLISIS COMPLETO!");
            hablar(`¬°Fierro! Ustedes son: ${res.t}. ${res.d}`, () => {
                // Leemos el an√°lisis ANTES de la foto
                setTimeout(() => cuentaRegresivaFoto(res), 500);
            });
        }

        function cuentaRegresivaFoto(resFinal) {
            setEmocion('feliz');
            cancelAnimationFrame(trackingReq); 
            
            let count = 3;
            textBubble.classList.add('alerta'); 

            const interval = setInterval(() => {
                 if(count > 0) {
                     mostrarTexto(count);
                     playSonido(800, 800, 0.1);
                     count--;
                 } else {
                     clearInterval(interval);
                     mostrarTexto("¬°SONR√çAN! üì∏");
                     playSonido(1000, 1200, 0.3);
                     setTimeout(() => tomarFoto(resFinal), 500);
                 }
            }, 1000);
        }

        function tomarFoto(res) {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            
            document.getElementById('foto-result').src = canvas.toDataURL('image/jpeg');
            // Frase elaborada
            document.getElementById('frase-final').innerText = `${res.t}: ${res.d}`;
            document.getElementById('modal').style.display = 'flex';

            // AUTO-RESET EN 20 SEGUNDOS
            iniciarAutoReset();
        }

        function iniciarAutoReset() {
            let timeLeft = 20;
            const timerEl = document.getElementById('timer-reset');
            const interval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = `Reiniciando en ${timeLeft}s...`;
                if(timeLeft <= 0) {
                    clearInterval(interval);
                    location.reload();
                }
            }, 1000);
        }

        // UTILS
        async function loopOjos() {
            const preds = await model.estimateFaces(video, false);
            if (preds.length > 0) {
                const p = preds[0];
                const x = (p.topLeft[0] + p.bottomRight[0]) / 2;
                const y = (p.topLeft[1] + p.bottomRight[1]) / 2;
                const xEye = (x / video.videoWidth - 0.5) * 60; 
                const yEye = (y / video.videoHeight - 0.5) * 50;
                document.querySelectorAll('.pupila').forEach(pup => {
                    pup.style.transform = `translate(${xEye}px, ${yEye}px)`;
                });
            }
            trackingReq = requestAnimationFrame(loopOjos);
        }

        function setEmocion(emo) {
            const cabeza = document.getElementById('cabeza');
            cabeza.className = ""; 
            if (emo !== 'normal') cabeza.classList.add(emo);
        }

        function hablar(texto, callback) {
            window.speechSynthesis.cancel();
            isSpeaking = true;
            const u = new SpeechSynthesisUtterance(texto);
            if (vozSeleccionada) u.voice = vozSeleccionada;
            u.lang = "es-MX";
            
            if (texto.includes("!")) { u.rate = 1.15; u.pitch = 1.2; }
            else if (texto.includes("?")) { u.rate = 1.0; u.pitch = 1.1; }
            else if (texto.includes("...")) { u.rate = 0.9; u.pitch = 0.9; }
            else { u.rate = 1.0; u.pitch = 1.0; }

            u.onstart = () => document.getElementById('cabeza').classList.add('hablando');
            u.onend = () => {
                document.getElementById('cabeza').classList.remove('hablando');
                isSpeaking = false;
                if(callback) callback();
            };
            window.speechSynthesis.speak(u);
        }

        function mostrarTexto(txt) {
            textBubble.innerText = txt;
            textBubble.classList.add('visible');
        }

        function mostrarBotones(lista) {
            btnContainer.innerHTML = "";
            lista.forEach((item, i) => {
                const btn = document.createElement('button');
                btn.className = i === 0 ? "btn btn-a" : "btn btn-b";
                btn.innerText = item.txt;
                btn.onclick = () => { btnContainer.innerHTML = ""; handleSeleccion(item.val); };
                btnContainer.appendChild(btn);
                setTimeout(() => btn.classList.add('show'), i * 150);
            });
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSonido(f1, f2, duracion = 0.5) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(f1, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(f2, audioCtx.currentTime + duracion);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duracion);
            osc.start(); osc.stop(audioCtx.currentTime + duracion);
        }

        function descargar() {
            const a = document.createElement('a');
            a.href = document.getElementById('foto-result').src;
            a.download = "CupidoIMJUEscuinapa.jpg";
            a.click();
        }
    </script>
</body>
</html>
