<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Or치culo v71 - Core Blindado</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <style>
        /* EST칄TICA M칈STICA (Optimizada para M칩vil y PC) */
        body { margin: 0; height: 100vh; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; user-select: none; }
        
        /* C츼MARA Y VIDEO */
        #webcam { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.4; transform: scaleX(-1); z-index: 0; }
        
        /* CAPAS VISUALES */
        #fondo-mistico { position: fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, rgba(13,71,161,0.6), #000); z-index: 1; pointer-events: none; transition: background 1s; mix-blend-mode: hard-light; }
        #particulas { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2; pointer-events: none; }
        
        /* UI CENTRAL */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        
        /* CABEZA (Avatar) */
        #cabeza { position: relative; margin-bottom: 20px; transition: transform 0.1s ease-out; filter: drop-shadow(0 0 15px rgba(255,255,255,0.3)); }
        .ojos-container { display: flex; gap: 30px; }
        .ojo { width: 100px; height: 160px; background: white; border-radius: 50%; position: relative; overflow: hidden; border: 4px solid rgba(255,255,255,0.1); }
        .pupila { width: 35px; height: 45px; background: #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: all 0.1s; }
        .parpado { position: absolute; width: 100%; background: #000; transition: 0.3s; z-index: 5; left: 0; height: 40%; } /* Estado Zen por defecto */
        .top { top: 0; } .bottom { bottom: 0; }

        /* ESTADOS OJOS */
        .ojo.abierto .top, .ojo.abierto .bottom { height: 0%; }
        .ojo.entrecerrado .top, .ojo.entrecerrado .bottom { height: 35%; }
        
        /* TEXTOS */
        #status-text { font-size: 14px; letter-spacing: 2px; text-transform: uppercase; color: #00e676; margin-bottom: 10px; text-shadow: 0 0 10px black; }
        #dialogo-principal { font-size: 24px; font-weight: bold; text-align: center; max-width: 90%; text-shadow: 0 2px 4px black; min-height: 60px; }

        /* BOTONES DE INTERACCI칍N */
        #botones-container { display: none; gap: 20px; margin-top: 30px; pointer-events: auto; }
        .btn-action { padding: 15px 40px; border: 1px solid white; background: rgba(0,0,0,0.6); color: white; border-radius: 30px; font-size: 16px; cursor: pointer; backdrop-filter: blur(4px); transition: 0.2s; }
        .btn-action:hover { background: white; color: black; transform: scale(1.05); }

        /* BOT칍N INICIO */
        #pantalla-inicio { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #btn-start { padding: 20px 50px; font-size: 20px; border: 2px solid #00e676; color: #00e676; background: transparent; border-radius: 50px; cursor: pointer; font-weight: bold; letter-spacing: 2px; }
        
        /* SENSOR */
        #sensor { position: fixed; bottom: 50px; width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 40px; pointer-events: auto; cursor: pointer; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); z-index: 100; }
        #sensor.activo { background: white; color: black; box-shadow: 0 0 50px white; transform: scale(0.95); }

        /* DEBUG VISUAL (Borde verde al detectar) */
        .detectado { box-shadow: inset 0 0 50px #00e676; }

    </style>
</head>
<body id="body">

    <video id="webcam" autoplay playsinline muted></video>
    <div id="fondo-mistico"></div>
    <canvas id="particulas"></canvas>

    <div id="ui-layer">
        <div id="status-text">ESPERANDO INICIO...</div>
        
        <div id="cabeza">
            <div class="ojos-container">
                <div class="ojo"><div class="parpado top"></div><div class="pupila"></div><div class="parpado bottom"></div></div>
                <div class="ojo"><div class="parpado top"></div><div class="pupila"></div><div class="parpado bottom"></div></div>
            </div>
        </div>

        <div id="dialogo-principal"></div>

        <div id="botones-container">
            <button class="btn-action" onclick="respuestaUsuario('si')">ACEPTAR</button>
            <button class="btn-action" onclick="respuestaUsuario('no')">AHORA NO</button>
        </div>
    </div>

    <div id="sensor" onmousedown="tocarSensor()" onmouseup="soltarSensor()" ontouchstart="tocarSensor()" ontouchend="soltarSensor()">游녡</div>

    <div id="pantalla-inicio">
        <button id="btn-start" onclick="iniciarSistema()">INICIAR RITUAL</button>
        <div style="margin-top:20px; color:gray; font-size:12px;">v71 Core Fix</div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // === API KEY ===
        const API_KEY = "AIzaSyBlJGQaWafqiSuituKURcRriR3t18YBnOs"; 

        // === VARIABLES GLOBALES ===
        let genAI, model, chat;
        let video = document.getElementById('webcam');
        let blazefaceModel = null;
        let estado = "OFF"; // OFF, BUSCANDO, CHARLANDO
        let isSpeaking = false;
        let nombreUsuario = "Viajero";

        // === 1. ARRANQUE DEL SISTEMA ===
        window.iniciarSistema = async function() {
            const btn = document.getElementById('btn-start');
            btn.innerText = "CALIBRANDO C츼MARA...";
            
            // Audio Unlock
            try { const ac = new (window.AudioContext || window.webkitAudioContext)(); ac.resume(); } catch(e){}

            // Iniciar Gemini
            try {
                genAI = new GoogleGenerativeAI(API_KEY);
                model = genAI.getGenerativeModel({ 
                    model: "gemini-1.5-flash",
                    systemInstruction: "Eres un Or치culo. Respuestas breves (max 15 palabras). Tono m칤stico."
                });
            } catch(e) { console.error("Error Gemini", e); }

            // Iniciar C치mara (CON RESTRICCIONES DE TAMA칌O PARA EVITAR ERRORES)
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } }, 
                    audio: false 
                });
                video.srcObject = stream;
                
                // Esperar a que el video tenga datos reales
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                // Cargar Blazeface
                blazefaceModel = await blazeface.load();

                // Ocultar inicio
                document.getElementById('pantalla-inicio').style.display = 'none';
                
                // Iniciar Chat
                chat = model.startChat();
                
                // Arrancar Bucle
                estado = "BUSCANDO";
                actualizarStatus("BUSCANDO ENERG칈A...");
                animLoop(); // Part칤culas
                detectarLoop(); // Visi칩n

            } catch (e) {
                alert("Error cr칤tico: " + e.message);
                btn.innerText = "ERROR - RECARGA";
            }
        };

        // === 2. BUCLE DE VISI칍N (EL CEREBRO) ===
        async function detectarLoop() {
            if (estado === "OFF") return;

            try {
                // Verificar que el modelo y el video est칠n listos
                if (blazefaceModel && video.readyState === 4) {
                    
                    const predictions = await blazefaceModel.estimateFaces(video, false);

                    if (predictions.length > 0) {
                        // DETECTADO
                        document.body.classList.add('detectado'); // Borde verde visual
                        
                        // Mover ojos (Seguimiento)
                        const p = predictions[0];
                        const x = (p.topLeft[0] + p.bottomRight[0]) / 2;
                        const eyeX = (1 - (x / video.videoWidth)) * 30 - 15; // Invertir e interpolar
                        moverOjos(eyeX);

                        // L칩gica de Estado
                        if (estado === "BUSCANDO") {
                            // Validar tama침o para asegurar cercan칤a
                            const anchoCara = p.bottomRight[0] - p.topLeft[0];
                            if (anchoCara > 35) { // Umbral bajo para detectar f치cil
                                console.log("Rostro confirmado. Iniciando saludo.");
                                iniciarInteraccion();
                            }
                        }

                    } else {
                        // NO DETECTADO
                        document.body.classList.remove('detectado');
                        moverOjos(0);
                    }
                }
            } catch (e) {
                console.warn("Error en bucle de visi칩n (ignorable):", e);
            }

            requestAnimationFrame(detectarLoop);
        }

        // === 3. L칍GICA DE INTERACCI칍N ===
        async function iniciarInteraccion() {
            estado = "CHARLANDO"; // Bloquear para que no se repita
            actualizarStatus("CONECTANDO CON EL OR츼CULO...");
            cambiarOjos("abierto");

            // Llamada segura a Gemini
            let saludo = await pedirGemini("Un usuario ha llegado. Sal칰dalo misticamente y pregunta su nombre.");
            hablar(saludo, () => {
                escuchar(nombre => {
                    nombreUsuario = nombre || "Ser de Luz";
                    // Fase 2
                    pedirGemini(`El usuario es ${nombreUsuario}. Inv칤talo a leer su aura.`).then(txt => {
                        hablar(txt, () => {
                            document.getElementById('botones-container').style.display = 'flex';
                        });
                    });
                });
            });
        }

        window.respuestaUsuario = function(tipo) {
            document.getElementById('botones-container').style.display = 'none';
            if(tipo === 'si') {
                pedirGemini("El usuario acept칩. Hazle una pregunta filos칩fica profunda pero breve.").then(preg => {
                    hablar(preg, () => flujoConversacion());
                });
            } else {
                hablar("El universo te esperar치. Adi칩s.", () => {
                    estado = "BUSCANDO"; 
                    cambiarOjos("entrecerrado");
                    actualizarStatus("BUSCANDO...");
                });
            }
        };

        function flujoConversacion() {
            escuchar(resp => {
                // Decisi칩n din치mica: Gemini decide si seguir o ir al sensor
                pedirGemini(`Usuario respondi칩: "${resp}". Si es suficiente, di 'USA EL SENSOR'. Si no, haz otra pregunta.`).then(txt => {
                    if(txt.toUpperCase().includes("SENSOR")) {
                        hablar("Es momento. Coloca tu dedo en el sensor.", () => {
                            document.getElementById('sensor').style.display = 'flex';
                        });
                    } else {
                        hablar(txt, () => flujoConversacion());
                    }
                });
            });
        }

        // === 4. SENSOR FINAL ===
        window.tocarSensor = function() {
            document.getElementById('sensor').classList.add('activo');
            actualizarStatus("LEYENDO AURA...");
            sonidoMistico();
            
            setTimeout(() => {
                document.getElementById('sensor').style.display = 'none';
                
                pedirGemini("Veredicto final: Define un color de aura y una predicci칩n futura.").then(final => {
                    let color = "#fff";
                    if(final.includes("Dorado")) color = "#ffd700";
                    if(final.includes("Violeta")) color = "#d500f9";
                    if(final.includes("Rojo")) color = "#ff1744";
                    if(final.includes("Azul")) color = "#00e5ff";
                    
                    document.getElementById('fondo-mistico').style.background = `radial-gradient(circle, ${color}, #000)`;
                    hablar(final, () => {
                        setTimeout(() => location.reload(), 5000);
                    });
                });
            }, 3000);
        }

        window.soltarSensor = function() { document.getElementById('sensor').classList.remove('activo'); }

        // === 5. CEREBRO H칈BRIDO (Gemini + Fallback) ===
        async function pedirGemini(prompt) {
            try {
                // Timeout de 5 segundos para no trabarse
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 5000));
                const apiPromise = chat.sendMessage(prompt);
                
                const result = await Promise.race([apiPromise, timeoutPromise]);
                return result.response.text();
            } catch (e) {
                console.log("Fallo Gemini o Timeout. Usando Backup.");
                // RESPUESTAS DE RESPALDO (Por si falla la red/API)
                if(prompt.includes("Sal칰dalo")) return "Bienvenido, viajero. 쮺u치l es tu nombre?";
                if(prompt.includes("Inv칤talo")) return `Interesante, ${nombreUsuario}. 쯈uieres que lea tu destino?`;
                if(prompt.includes("pregunta")) return "쯊e gu칤a la raz칩n o la pasi칩n?";
                if(prompt.includes("Veredicto")) return "Tu aura es Violeta. Grandes cambios se aproximan.";
                return "Las estrellas guardan silencio. Contin칰a.";
            }
        }

        // === 6. I/O (Voz y Ojos) ===
        function hablar(txt, cb) {
            document.getElementById('dialogo-principal').innerText = txt;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            
            // Buscar voz en espa침ol
            const voces = window.speechSynthesis.getVoices();
            const v = voces.find(voz => voz.lang.startsWith('es'));
            if(v) u.voice = v;
            u.rate = 1.1;

            u.onstart = () => isSpeaking = true;
            u.onend = () => { isSpeaking = false; if(cb) cb(); };
            window.speechSynthesis.speak(u);
        }

        function escuchar(cb) {
            if(isSpeaking) return;
            actualizarStatus("ESCUCHANDO...");
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SpeechRecognition) {
                setTimeout(() => {
                    let r = prompt("Escribe tu respuesta:");
                    cb(r || "...");
                }, 1000);
                return;
            }
            
            const rec = new SpeechRecognition();
            rec.lang = 'es-MX';
            rec.start();
            rec.onresult = (e) => {
                actualizarStatus("PROCESANDO...");
                cb(e.results[0][0].transcript);
            };
            rec.onerror = () => cb("Silencio");
        }

        function moverOjos(x) {
            const pupilas = document.querySelectorAll('.pupila');
            pupilas.forEach(p => p.style.transform = `translate(calc(-50% + ${x}px), -50%)`);
        }
        
        function cambiarOjos(estado) {
            const ojos = document.querySelectorAll('.ojo');
            ojos.forEach(o => {
                o.classList.remove('abierto', 'entrecerrado');
                if(estado !== 'zen') o.classList.add(estado);
            });
        }

        function actualizarStatus(txt) { document.getElementById('status-text').innerText = txt; }
        
        // Sonido
        function sonidoMistico() {
            try {
                const ac = new AudioContext();
                const osc = ac.createOscillator();
                const gain = ac.createGain();
                osc.connect(gain); gain.connect(ac.destination);
                osc.frequency.setValueAtTime(200, ac.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, ac.currentTime + 2);
                gain.gain.setValueAtTime(0.1, ac.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + 2);
                osc.start(); osc.stop(ac.currentTime + 2);
            } catch(e){}
        }

        // Part칤culas
        const cvs = document.getElementById('particulas');
        const ctx = cvs.getContext('2d');
        cvs.width = window.innerWidth; cvs.height = window.innerHeight;
        let pArray = Array.from({length:50}, () => ({x:Math.random()*cvs.width, y:Math.random()*cvs.height, vx:(Math.random()-.5), vy:(Math.random()-.5)}));
        function animLoop() {
            ctx.clearRect(0,0,cvs.width,cvs.height);
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            pArray.forEach(p => {
                p.x+=p.vx; p.y+=p.vy;
                if(p.x<0||p.x>cvs.width) p.vx*=-1; if(p.y<0||p.y>cvs.height) p.vy*=-1;
                ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(animLoop);
        }

    </script>
</body>
</html>
