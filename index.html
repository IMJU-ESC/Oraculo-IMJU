<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Or√°culo del Amor - v8 Final</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #ff0055; --skin: #ffccbc; }
        body { margin: 0; height: 100vh; overflow: hidden; background: #000; font-family: 'Fredoka', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* VIDEO DE FONDO */
        #webcam { position: fixed; top: 0; left: 0; min-width: 100%; min-height: 100%; object-fit: cover; z-index: -2; opacity: 0; transition: opacity 2s; }
        #capa-oscura { position: fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.9) 80%); z-index: -1; }

        /* AVATAR GIGANTE */
        #cabeza { 
            position: relative; width: 280px; height: 280px; /* M√ÅS GRANDE */
            background: white; border-radius: 45% 45% 40% 40%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            box-shadow: 0 0 60px rgba(255, 255, 255, 0.2);
            transition: transform 0.3s cubic-bezier(0.25, 1.5, 0.5, 1);
            z-index: 10; margin-bottom: 30px;
        }
        
        /* OJOS QUE SIGUEN */
        .ojos-row { display: flex; gap: 50px; margin-top: -20px; }
        .ojo { 
            width: 80px; height: 90px; background: #222; border-radius: 50%; 
            position: relative; overflow: hidden; transition: 0.2s; border: 4px solid #ddd;
        }
        .pupila { 
            width: 30px; height: 30px; background: white; border-radius: 50%; 
            position: absolute; top: 30%; left: 30%; box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        .brillo { width: 10px; height: 10px; background: white; position: absolute; top: 15px; right: 15px; border-radius: 50%; }

        /* BOCA */
        .boca { 
            width: 40px; height: 15px; background: #222; border-radius: 20px; 
            margin-top: 40px; transition: 0.3s; 
        }
        .hablando .boca { 
            width: 60px; height: 40px; background: #ff0055; 
            animation: hablar 0.25s infinite alternate; 
            border-radius: 50% 50% 20% 20%;
        }

        /* EXPRESIONES */
        .sorpresa #cabeza { transform: scale(1.1); }
        .sorpresa .ojo { height: 110px; width: 90px; }
        .enamorado .ojo { background: #ff0055; border-color: #ff80ab; }
        .enamorado .pupila { display: none; }
        .enamorado .ojo::after { content: '‚ù§Ô∏è'; font-size: 50px; position: absolute; top: 10px; left: 15px; animation: latido 0.5s infinite; }
        .pensando #cabeza { transform: rotate(15deg); }
        
        @keyframes hablar { from { height: 10px; } to { height: 50px; } }
        @keyframes latido { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        /* INTERFAZ DE TEXTO */
        #globo-texto {
            font-size: 1.8rem; color: white; text-align: center; 
            text-shadow: 0 3px 10px black; max-width: 90%; min-height: 80px;
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 30px;
            backdrop-filter: blur(5px); margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.1);
        }

        /* BOTONES */
        #opciones { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; width: 100%; pointer-events: auto; }
        .btn {
            padding: 25px 50px; font-size: 1.5rem; border: none; border-radius: 60px;
            cursor: pointer; font-family: 'Fredoka', sans-serif; font-weight: bold;
            transition: transform 0.2s, background 0.2s; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0; animation: entradaBtn 0.5s forwards;
        }
        @keyframes entradaBtn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
        
        .btn:hover { transform: scale(1.1); }
        .btn-main { background: white; color: #ff0055; }
        .btn-alt { background: #333; color: white; border: 2px solid white; }

        /* SENSOR */
        #sensor-container { display: none; flex-direction: column; align-items: center; margin-top: 20px; }
        #sensor {
            width: 140px; height: 140px; border-radius: 50%;
            border: 6px dashed rgba(255,255,255,0.5); display: flex; align-items: center; justify-content: center;
            font-size: 4rem; cursor: pointer; animation: girar 10s linear infinite;
        }
        #sensor.active { background: #ff0055; border-style: solid; border-color: white; animation: none; transform: scale(0.95); }
        @keyframes girar { to { transform: rotate(360deg); } }

        /* MODAL FINAL */
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 5000; flex-direction:column; align-items:center; justify-content:center; }
        #marco-foto { background: white; padding: 20px 20px 80px 20px; transform: rotate(-2deg); box-shadow: 0 0 50px rgba(255,0,85,0.5); }
        #foto-canvas { width: 100%; max-width: 500px; border: 2px solid #eee; }
        #texto-final { color: #d81b60; font-family: cursive; font-size: 2.5rem; margin-top: 20px; text-align: center; }

        /* PANTALLA INICIO */
        #start-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:#d81b60; z-index: 9999; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:white; font-size:4rem; margin-bottom:10px">CUPIDO.AI</h1>
        <p style="color:white; font-size:1.5rem; opacity:0.8">Conectando con el cosmos...</p>
        <button class="btn btn-main" id="btn-init" onclick="iniciar()" disabled>CARGANDO C√ÅMARA...</button>
    </div>

    <video id="webcam" autoplay playsinline muted></video>
    <div id="capa-oscura"></div>

    <div id="cabeza">
        <div class="ojos-row">
            <div class="ojo"><div class="pupila"></div><div class="brillo"></div></div>
            <div class="ojo"><div class="pupila"></div><div class="brillo"></div></div>
        </div>
        <div class="boca"></div>
    </div>

    <div id="globo-texto">...</div>

    <div id="opciones"></div>

    <div id="sensor-container">
        <div id="sensor" onmousedown="tocar(true)" onmouseup="tocar(false)" ontouchstart="tocar(true)" ontouchend="tocar(false)">üîÆ</div>
        <p style="font-weight:bold; font-size:1.5rem; margin-top:10px;">MANT√âN PULSADO</p>
    </div>

    <div id="modal">
        <div id="marco-foto">
            <img id="foto-canvas" src="">
            <div id="texto-final">Amor Eterno</div>
        </div>
        <div style="margin-top:30px; display:flex; gap:20px;">
            <button class="btn btn-main" onclick="descargar()">GUARDAR</button>
            <button class="btn btn-alt" onclick="location.reload()">REINICIAR</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        const API_KEY = "AIzaSyBlJGQaWafqiSuituKURcRriR3t18YBnOs";
        const MAX_PREGUNTAS = 4; // N√∫mero de preguntas antes del resultado

        // VARIABLES DE ESTADO
        let modelo;
        let estado = "INIT"; 
        let modoJuego = ""; // 'SOLO', 'PAREJA', 'AMIGOS'
        let preguntaIndex = 0;
        let historyChat = [];
        let isSpeaking = false;
        
        // Elementos
        const video = document.getElementById('webcam');
        const cabeza = document.getElementById('cabeza');
        const globo = document.getElementById('globo-texto');
        const divOpciones = document.getElementById('opciones');

        // --- 1. INICIALIZACI√ìN ---
        async function setup() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                modelo = await blazeface.load();
                
                document.getElementById('btn-init').innerText = "COMENZAR EXPERIENCIA";
                document.getElementById('btn-init').disabled = false;
            } catch (e) {
                alert("Error: Necesitamos la c√°mara para ver tu alma.");
            }
        }
        setup();

        function iniciar() {
            document.getElementById('start-screen').style.display = 'none';
            video.style.opacity = 1;
            // Iniciamos ciclo de detecci√≥n de rostros
            detectarRostros();
            // Iniciamos l√≥gica principal
            flowBienvenida();
        }

        // --- 2. SISTEMA DE VISI√ìN (OJOS QUE SIGUEN) ---
        async function detectarRostros() {
            if (estado === "FOTO") return; // Pausa en foto

            const preds = await modelo.estimateFaces(video, false);
            
            if (preds.length > 0) {
                // Tomamos la primera cara para mover los ojos
                const p = preds[0];
                const x = (p.topLeft[0] + p.bottomRight[0]) / 2;
                const y = (p.topLeft[1] + p.bottomRight[1]) / 2;
                
                // Mapeo de coordenadas c√°mara -> pupilas CSS
                // El rango de movimiento se ajusta para que parezca que mira "hacia afuera"
                let xEye = (x / video.videoWidth - 0.5) * 50; 
                let yEye = (y / video.videoHeight - 0.5) * 40;
                
                document.querySelectorAll('.pupila').forEach(pupila => {
                    pupila.style.transform = `translate(${xEye}px, ${yEye}px)`;
                });
            } else {
                // Si no hay nadie, ojos al centro
                document.querySelectorAll('.pupila').forEach(pupila => {
                    pupila.style.transform = `translate(0px, 0px)`;
                });
            }
            
            requestAnimationFrame(detectarRostros);
        }

        // --- 3. FLUJO DE CONVERSACI√ìN (RITMO CONTROLADO) ---
        
        function flowBienvenida() {
            setExpresion('normal');
            hablar("Hola... Soy Cupido Digital. Ac√©rquense m√°s, necesito ver sus auras...", () => {
                // Peque√±a pausa dram√°tica
                setTimeout(() => {
                    hablar("¬øQui√©n est√° ah√≠? ¬øVienes solo a descubrirte o acompa√±ado?", () => {
                        mostrarBotones([
                            {txt: "Vengo Solo/a üë§", val: "SOLO"},
                            {txt: "Somos Dos üë•", val: "DOS"}
                        ]);
                    });
                }, 500);
            });
        }

        async function manejarSeleccion(val) {
            divOpciones.innerHTML = ""; // Limpiar botones
            
            if (val === "SOLO") {
                modoJuego = "SOLO";
                hablar("Interesante... Un alma libre. Vamos a analizar tu 'Personalidad Rom√°ntica'.", flowPreguntas);
            } 
            else if (val === "DOS") {
                hablar("¬°Dos energ√≠as! Pero... ¬øqu√© sois?", () => {
                    mostrarBotones([
                        {txt: "Pareja ‚ù§Ô∏è", val: "PAREJA"},
                        {txt: "Amigos ü§ù", val: "AMIGOS"}
                    ]);
                });
            }
            else if (val === "PAREJA") {
                modoJuego = "PAREJA";
                hablar("A ver si es amor verdadero o solo costumbre. Comencemos el test.", flowPreguntas);
            }
            else if (val === "AMIGOS") {
                modoJuego = "AMIGOS";
                hablar("Amistad... o 'Friendzone'. Vamos a ver qu√© tan compatibles sois.", flowPreguntas);
            }
            else {
                // Es una respuesta a una pregunta del Quiz
                historyChat.push(val);
                reaccionIntermedia();
            }
        }

        // --- 4. MOTOR DE PREGUNTAS (LOOP DE 4) ---
        async function flowPreguntas() {
            if (preguntaIndex >= MAX_PREGUNTAS) {
                // Fin del juego -> Sensor
                flowSensor();
                return;
            }

            preguntaIndex++;
            setExpresion('pensando');
            globo.innerText = "Pensando pregunta...";
            
            // Generar pregunta basada en el modo y el n√∫mero de pregunta
            let prompt = "";
            let contexto = "";
            
            if (modoJuego === "SOLO") {
                contexto = "un usuario soltero para definir su personalidad amorosa";
                if(preguntaIndex===1) prompt = "Pregunta sobre primera cita ideal.";
                if(preguntaIndex===2) prompt = "Pregunta sobre celos o espacio personal.";
                if(preguntaIndex===3) prompt = "Pregunta sobre creer en el destino.";
                if(preguntaIndex===4) prompt = "Pregunta divertida sobre ex parejas.";
            } else if (modoJuego === "PAREJA") {
                contexto = "una pareja para probar su compatibilidad";
                if(preguntaIndex===1) prompt = "Pregunta sobre qui√©n es m√°s desordenado.";
                if(preguntaIndex===2) prompt = "Pregunta sobre qui√©n gana m√°s dinero o gasta m√°s.";
                if(preguntaIndex===3) prompt = "Dilema moral divertido.";
                if(preguntaIndex===4) prompt = "Pregunta picante o rom√°ntica final.";
            } else { // AMIGOS
                contexto = "dos amigos para ver si son buena influencia";
                prompt = "Pregunta divertida sobre fiestas, secretos o lealtad.";
            }

            // Llamada a IA (o Fallback)
            let data = await generarPreguntaIA(contexto, prompt);
            
            setExpresion('normal');
            hablar(data.pregunta, () => {
                mostrarBotones([
                    {txt: data.opcionA, val: "A"},
                    {txt: data.opcionB, val: "B"}
                ]);
            });
        }

        async function reaccionIntermedia() {
            divOpciones.innerHTML = "";
            setExpresion('sorpresa');
            
            // Reacci√≥n simple para mantener ritmo
            const frases = ["¬°Vaya, no me esperaba eso!", "Interesante...", "Tomando nota...", "Uy, qu√© fuerte.", "Aj√°...", "Eso explica mucho."];
            const random = frases[Math.floor(Math.random() * frases.length)];
            
            hablar(random, () => {
                // Pausa antes de la siguiente pregunta
                setTimeout(flowPreguntas, 1000);
            });
        }

        // --- 5. FASE SENSOR Y RESULTADO ---
        function flowSensor() {
            setExpresion('normal');
            let txt = modoJuego === "SOLO" ? "Suficiente informaci√≥n. Pon tu dedo en el esc√°ner para leer tu aura final." : "Ya s√© todo lo que necesito. Poned vuestros dedos juntos en el sensor.";
            
            hablar(txt, () => {
                document.getElementById('sensor-container').style.display = 'flex';
            });
        }

        let timerSensor;
        function tocar(activo) {
            const s = document.getElementById('sensor');
            if (activo) {
                s.classList.add('active');
                playSonido('magia');
                globo.innerText = "LEYENDO ENERG√çA C√ìSMICA...";
                timerSensor = setTimeout(mostrarResultadoFinal, 3000); // 3 segundos de lectura
            } else {
                s.classList.remove('active');
                clearTimeout(timerSensor);
                globo.innerText = "¬°No lo sueltes!";
            }
        }

        async function mostrarResultadoFinal() {
            document.getElementById('sensor-container').style.display = 'none';
            setExpresion('enamorado');
            playSonido('exito');
            
            globo.innerText = "ANALIZANDO DATOS...";
            
            // Generar veredicto final
            let prompt = `Genera una frase final muy divertida y un porcentaje de 0 a 100 para ${modoJuego}. Formato: "80% - Frase"`;
            let resultadoTxt = await consultarGeminiSimple(prompt);
            
            hablar(`¬°Lo tengo! Vuestro resultado es... ${resultadoTxt}. ¬°Sonre√≠d para la foto!`, () => {
                setTimeout(() => tomarFoto(resultadoTxt), 1000);
            });
        }

        function tomarFoto(texto) {
            estado = "FOTO";
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Espejo
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            
            document.getElementById('foto-canvas').src = canvas.toDataURL('image/jpeg');
            document.getElementById('texto-final').innerText = texto;
            document.getElementById('modal').style.display = 'flex';
        }

        // --- 6. CEREBRO IA (GEMINI + FALLBACK ROBUSTO) ---
        async function generarPreguntaIA(contexto, tema) {
            const prompt = `Genera un JSON con una pregunta corta y divertida y dos respuestas cortas para ${contexto}. Tema: ${tema}. Formato JSON: {"pregunta": "¬øTexto?", "opcionA": "Resp1", "opcionB": "Resp2"}`;
            
            try {
                // INTENTO 1: GEMINI
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 3500); // Timeout 3.5s

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    signal: controller.signal
                });
                clearTimeout(id);
                
                if(!res.ok) throw new Error("API Fail");
                const data = await res.json();
                let raw = data.candidates[0].content.parts[0].text;
                // Limpiar JSON (a veces Gemini pone ```json ...)
                raw = raw.replace(/```json|```/g, '').trim();
                return JSON.parse(raw);

            } catch (e) {
                console.warn("Usando Fallback Local:", e);
                // BASE DE DATOS LOCAL (POR SI FALLA)
                return obtenerPreguntaLocal();
            }
        }

        async function consultarGeminiSimple(prompt) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text.replace(/\*/g,'');
            } catch(e) {
                return "100% - ¬°Destino Puro!";
            }
        }

        function obtenerPreguntaLocal() {
            const db = {
                SOLO: [
                    {pregunta: "¬øCrees en el amor a primera vista?", opcionA: "S√≠, total", opcionB: "No, es qu√≠mica"},
                    {pregunta: "¬øViernes noche ideal?", opcionA: "Fiesta loca", opcionB: "Netflix y manta"},
                    {pregunta: "¬øPerdonar√≠as una infidelidad?", opcionA: "Jam√°s", opcionB: "Depende"},
                    {pregunta: "¬øTe enamoras r√°pido?", opcionA: "En 5 minutos", opcionB: "Tardo a√±os"}
                ],
                PAREJA: [
                    {pregunta: "¬øQui√©n es m√°s probable que olvide el aniversario?", opcionA: "√âl/Ella", opcionB: "Yo"},
                    {pregunta: "¬øQui√©n cocina mejor?", opcionA: "Yo, obvio", opcionB: "Mi pareja"},
                    {pregunta: "¬øQui√©n ronca m√°s fuerte?", opcionA: "Ni te imaginas", opcionB: "Silencio total"},
                    {pregunta: "¬øQui√©n gana en una pelea?", opcionA: "Yo siempre", opcionB: "Cedo yo"}
                ],
                AMIGOS: [
                    {pregunta: "¬øQui√©n acabar√≠a en la c√°rcel primero?", opcionA: "Yo", opcionB: "Mi amigo/a"},
                    {pregunta: "¬øQui√©n debe dinero a qui√©n?", opcionA: "Yo debo", opcionB: "Me debe"},
                    {pregunta: "¬øQui√©n liga m√°s?", opcionA: "Soy un im√°n", opcionB: "√âl/Ella gana"}
                ]
            };
            // Selecciona una al azar del array correspondiente al modo
            const list = db[modoJuego] || db['SOLO'];
            return list[Math.floor(Math.random() * list.length)];
        }


        // --- UTILIDADES VISUALES Y AUDIO ---
        function hablar(texto, callback) {
            isSpeaking = true;
            globo.innerText = texto;
            cabeza.classList.add('hablando');
            
            // Voz
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(texto);
            u.lang = "es-MX";
            u.rate = 1.0; // Velocidad normal, no r√°pida
            u.pitch = 1.1;

            u.onend = () => {
                cabeza.classList.remove('hablando');
                isSpeaking = false;
                if(callback) callback();
            };
            window.speechSynthesis.speak(u);
        }

        function mostrarBotones(lista) {
            divOpciones.innerHTML = "";
            lista.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "btn btn-main";
                btn.innerText = item.txt;
                btn.onclick = () => manejarSeleccion(item.val);
                divOpciones.appendChild(btn);
            });
        }

        function setExpresion(tipo) {
            cabeza.className = "";
            if(tipo !== 'normal') cabeza.classList.add(tipo);
        }

        // Generador de sonidos simple con Web Audio API
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSonido(tipo) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if (tipo === 'magia') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 2);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime+2);
            } else if (tipo === 'exito') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, audioCtx.currentTime); // La
                gain.gain.value = 0.1;
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
                // Un acorde simple manual
                setTimeout(()=>{
                    const o2=audioCtx.createOscillator(); const g2=audioCtx.createGain();
                    o2.connect(g2); g2.connect(audioCtx.destination);
                    o2.frequency.value=554; g2.gain.value=0.1; o2.start(); o2.stop(audioCtx.currentTime+0.5);
                }, 100);
            }
        }
        
        function descargar() {
            const a = document.createElement('a');
            a.href = document.getElementById('foto-canvas').src;
            a.download = "cupido_resultado.jpg";
            a.click();
        }

    </script>
</body>
</html>
