<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oráculo Místico v67 - Final</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        body { margin: 0; height: 100vh; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; user-select: none; }
        
        /* CÁMARA Y FONDO */
        #webcam { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; z-index: 0; pointer-events: none; transform: scaleX(-1); }
        #fondo-dinamico { position: fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at 50% 50%, #1a237e, #000); z-index: 1; mix-blend-mode: hard-light; transition: background 2s ease; opacity: 0.8; }
        #particulas { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2; pointer-events: none; }
        
        /* AVATAR */
        #cabeza { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; transition: transform 0.2s; filter: drop-shadow(0 0 20px rgba(255,255,255,0.5)); }
        .ojos-container { display: flex; gap: 40px; }
        .ojo { width: 120px; height: 180px; background: white; border-radius: 50%; position: relative; overflow: hidden; border: 3px solid rgba(255,255,255,0.2); }
        .pupila { width: 40px; height: 50px; background: #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: all 0.1s; }
        .parpado { position: absolute; width: 100%; height: 10%; background: #000; transition: 0.3s; z-index: 5; left: 0; }
        .top { top: 0; } .bottom { bottom: 0; }
        
        /* ESTADOS DE OJOS */
        .zen .top, .zen .bottom { height: 40%; }
        .abierto .top, .abierto .bottom { height: 0%; }
        .hablando { animation: flotar 3s infinite ease-in-out; }
        @keyframes flotar { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }

        /* TEXTO Y UI */
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        #texto-status { position: fixed; top: 20px; font-size: 14px; color: #00e676; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px #00e676; }
        #subtitulos { margin-top: 300px; font-size: 24px; text-align: center; max-width: 80%; text-shadow: 0 2px 5px black; font-weight: bold; min-height: 60px; }
        
        /* BOTONES INTERACTIVOS */
        #pantalla-inicio { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        #btn-start { padding: 25px 60px; font-size: 20px; background: transparent; border: 2px solid #00e676; color: #00e676; border-radius: 50px; cursor: pointer; transition: 0.3s; font-weight: bold; letter-spacing: 2px; }
        #btn-start:hover { background: #00e676; color: black; box-shadow: 0 0 30px #00e676; }

        #botones-respuesta { display: none; gap: 20px; margin-top: 20px; pointer-events: auto; }
        .btn-resp { padding: 15px 40px; background: rgba(255,255,255,0.1); border: 1px solid white; color: white; border-radius: 30px; cursor: pointer; backdrop-filter: blur(5px); transition: 0.2s; }
        .btn-resp:hover { background: white; color: black; transform: scale(1.1); }

    </style>
</head>
<body>

    <video id="webcam" autoplay playsinline muted></video>
    <div id="fondo-dinamico"></div>
    <canvas id="particulas"></canvas>

    <div id="ui-layer">
        <div id="texto-status">SISTEMA INACTIVO</div>
        
        <div id="cabeza" class="zen">
            <div class="ojos-container">
                <div class="ojo"><div class="parpado top"></div><div class="pupila"></div><div class="parpado bottom"></div></div>
                <div class="ojo"><div class="parpado top"></div><div class="pupila"></div><div class="parpado bottom"></div></div>
            </div>
        </div>

        <div id="subtitulos"></div>

        <div id="botones-respuesta">
            <button class="btn-resp" onclick="responder('si')">ACEPTAR DESTINO</button>
            <button class="btn-resp" onclick="responder('no')">AHORA NO</button>
        </div>
    </div>

    <div id="pantalla-inicio">
        <button id="btn-start" onclick="iniciarRitual()">INICIAR RITUAL</button>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // === CONFIGURACIÓN ===
        const API_KEY = "AIzaSyBlJGQaWafqiSuituKURcRriR3t18YBnOs"; 
        let genAI, model;
        let usarBackup = false; // Se activa si falla Gemini

        // === VARIABLES ===
        let video = document.getElementById('webcam');
        let blazefaceModel = null;
        let estado = "OFF"; // OFF, BUSCANDO, INTERACTUANDO
        let nombreUsuario = "Viajero";

        // === 1. INICIO DEL SISTEMA ===
        window.iniciarRitual = async function() {
            document.getElementById('btn-start').innerText = "CONECTANDO...";
            
            // Activar AudioContext
            try { const ac = new (window.AudioContext || window.webkitAudioContext)(); ac.resume(); } catch(e){}

            // Configurar Gemini
            try {
                genAI = new GoogleGenerativeAI(API_KEY);
                model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            } catch (e) {
                console.error("Error iniciando Gemini:", e);
                usarBackup = true; // Activar modo seguro
            }

            // Iniciar Cámara
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                
                blazefaceModel = await blazeface.load();
                
                // Todo listo
                document.getElementById('pantalla-inicio').style.opacity = 0;
                setTimeout(() => document.getElementById('pantalla-inicio').style.display = 'none', 1000);
                
                estado = "BUSCANDO";
                actualizarStatus("BUSCANDO ROSTRO...");
                setOjos("zen");
                detectarLoop();
                animarParticulas();

            } catch (e) {
                alert("Error de cámara: " + e.message);
            }
        };

        // === 2. BUCLE DE VISIÓN ===
        async function detectarLoop() {
            if(estado === "OFF") return;

            if (blazefaceModel) {
                const returnTensors = false;
                const predictions = await blazefaceModel.estimateFaces(video, returnTensors);

                if (predictions.length > 0) {
                    // Mover pupilas
                    const p = predictions[0];
                    const centerX = (p.topLeft[0] + p.bottomRight[0]) / 2;
                    // Mover pupilas opuestas al movimiento (efecto espejo)
                    let xEye = (1 - (centerX / video.videoWidth)) * 20 - 10; 
                    moverPupilas(xEye, 0);

                    if (estado === "BUSCANDO") {
                        const size = p.bottomRight[0] - p.topLeft[0];
                        // Umbral de tamaño (30 es suficiente)
                        if (size > 30) {
                            encontrarUsuario();
                        }
                    }
                } else {
                    moverPupilas(0, 0);
                }
            }
            requestAnimationFrame(detectarLoop);
        }

        // === 3. LÓGICA DE INTERACCIÓN ===
        async function encontrarUsuario() {
            estado = "INTERACTUANDO";
            setOjos("abierto");
            actualizarStatus("CONEXIÓN ESTABLECIDA");
            
            // Saludo Inicial
            let saludo = await pedirIA("Un usuario acaba de aparecer. Salúdalo misticamente en 10 palabras y pide su nombre.");
            hablar(saludo, () => {
                escucharRespuesta((nombre) => {
                    nombreUsuario = nombre || "Ser de luz";
                    
                    // Segunda Fase: Invitación
                    pedirIA(`El usuario se llama ${nombreUsuario}. Invítalo a leer su aura (max 10 palabras).`).then(txt => {
                        hablar(txt, () => {
                            document.getElementById('botones-respuesta').style.display = 'flex';
                        });
                    });
                });
            });
        }

        window.responder = function(tipo) {
            document.getElementById('botones-respuesta').style.display = 'none';
            if (tipo === 'si') {
                lecturaAura();
            } else {
                hablar("El universo es paciente. Regresa cuando estés listo.", () => {
                    estado = "BUSCANDO";
                    setOjos("zen");
                    actualizarStatus("BUSCANDO...");
                });
            }
        };

        async function lecturaAura() {
            actualizarStatus("LEYENDO ENERGÍA...");
            setOjos("hablando");
            hablar("Cierra los ojos... Siento tu energía fluir...", async () => {
                // Efecto visual
                document.getElementById('fondo-dinamico').style.background = "radial-gradient(circle, #fff, #000)";
                setTimeout(() => {
                    // Elegir color aleatorio o por IA
                    const colores = ["#ffd700", "#d500f9", "#00e676", "#ff1744", "#00e5ff"];
                    const colorFinal = colores[Math.floor(Math.random() * colores.length)];
                    document.getElementById('fondo-dinamico').style.background = `radial-gradient(circle, ${colorFinal}, #000)`;
                    
                    pedirIA(`Analiza el aura de ${nombreUsuario} y predice su futuro en una frase críptica y poética.`).then(prediccion => {
                        setOjos("abierto");
                        hablar(prediccion, () => {
                            setTimeout(() => {
                                hablar("La sesión ha finalizado. Hasta pronto.", () => {
                                    location.reload();
                                });
                            }, 3000);
                        });
                    });
                }, 2000);
            });
        }

        // === 4. CEREBRO HÍBRIDO (IA + RESPALDO) ===
        async function pedirIA(prompt) {
            if (usarBackup) return respuestaBackup(prompt);

            try {
                const result = await model.generateContent(prompt);
                const response = await result.response;
                return response.text();
            } catch (error) {
                console.warn("Fallo Gemini (Posible 404/Quota). Usando respaldo.", error);
                usarBackup = true; // Cambiar a modo respaldo permanentemente
                return respuestaBackup(prompt);
            }
        }

        function respuestaBackup(prompt) {
            // Respuestas pre-grabadas por si falla la API
            if (prompt.includes("Salúdalo")) return "Saludos, viajero de las estrellas. ¿Cual es tu nombre terrenal?";
            if (prompt.includes("Invítalo")) return `Interesante energía, ${nombreUsuario}. ¿Me permites leer tu aura hoy?`;
            if (prompt.includes("futuro")) return "Tu aura brilla con intensidad. El caos pronto se transformará en una gran oportunidad.";
            return "Las estrellas susurran tu nombre.";
        }

        // === 5. VOZ Y OÍDO ===
        function hablar(texto, callback) {
            document.getElementById('subtitulos').innerText = texto;
            window.speechSynthesis.cancel();
            
            const u = new SpeechSynthesisUtterance(texto);
            u.lang = "es-MX"; 
            u.rate = 1.1; 
            
            u.onstart = () => document.getElementById('cabeza').classList.add('hablando');
            u.onend = () => {
                document.getElementById('cabeza').classList.remove('hablando');
                if (callback) callback();
            };
            
            window.speechSynthesis.speak(u);
        }

        function escucharRespuesta(callback) {
            document.getElementById('subtitulos').innerText = "ESCUCHANDO...";
            
            // Simulación simple si no hay SpeechRecognition (mejor compatibilidad móvil)
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                // Fallback a prompt
                setTimeout(() => {
                    const r = prompt("Escribe tu respuesta:");
                    callback(r || "Desconocido");
                }, 500);
                return;
            }

            const rec = new SpeechRecognition();
            rec.lang = "es-MX";
            rec.start();
            rec.onresult = (e) => callback(e.results[0][0].transcript);
            rec.onerror = () => callback("Silencio");
        }

        // === UTILS VISUALES ===
        function actualizarStatus(txt) { document.getElementById('texto-status').innerText = txt; }
        function setOjos(clase) { document.getElementById('cabeza').className = clase; }
        function moverPupilas(x, y) {
            const pupilas = document.querySelectorAll('.pupila');
            pupilas.forEach(p => p.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`);
        }

        // Partículas Fondo
        function animarParticulas() {
            const cvs = document.getElementById('particulas');
            const ctx = cvs.getContext('2d');
            cvs.width = window.innerWidth; cvs.height = window.innerHeight;
            let parts = Array.from({length:50}, () => ({
                x: Math.random()*cvs.width, y: Math.random()*cvs.height,
                vx: (Math.random()-0.5), vy: (Math.random()-0.5)
            }));

            function loop() {
                ctx.clearRect(0,0,cvs.width, cvs.height);
                ctx.fillStyle = "rgba(255,255,255,0.3)";
                parts.forEach(p => {
                    p.x += p.vx; p.y += p.vy;
                    if(p.x < 0 || p.x > cvs.width) p.vx *= -1;
                    if(p.y < 0 || p.y > cvs.height) p.vy *= -1;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                });
                requestAnimationFrame(loop);
            }
            loop();
        }
    </script>
</body>
</html>
