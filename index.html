<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cupido IMJU Escuinapa - Final</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Bangers&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILO GENERAL --- */
        :root { --imju-pink: #ff006e; --imju-purple: #8338ec; --imju-orange: #fb5607; }
        
        body {
            margin: 0; height: 100vh; overflow: hidden; font-family: 'Fredoka', sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #8338ec, #ff006e, #fb5607);
            background-size: 300% 300%;
            animation: fondoEscuinapa 15s ease infinite;
            color: white;
            user-select: none;
        }
        @keyframes fondoEscuinapa {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* EMOJIS FLOTANTES (Escuinapa Vibes) */
        .emoji-float {
            position: absolute; bottom: -50px; font-size: 2.5rem; opacity: 0.2;
            animation: subir 9s linear infinite; pointer-events: none; z-index: 0;
        }
        @keyframes subir {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; }
        }

        #webcam { position: fixed; top: 0; left: 0; visibility: hidden; pointer-events: none; }

        /* --- HEADER --- */
        #header-imju {
            position: fixed; top: 20px; text-align: center; z-index: 50;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.15);
        }
        #header-imju h1 { margin: 0; font-family: 'Bangers', cursive; font-size: 4rem; letter-spacing: 2px; color: white; }
        #header-imju p { margin: 0; font-size: 1.4rem; font-weight: bold; background: rgba(255,255,255,0.2); padding: 5px 20px; border-radius: 30px; display: inline-block; }

        /* --- AVATAR GIGANTE --- */
        #avatar-container { 
            position: relative; width: 550px; height: 450px; /* TAMA√ëO MAXIMIZADO */
            z-index: 10; margin-bottom: 20px; margin-top: 50px;
        }
        
        #cabeza {
            width: 100%; height: 100%; background: transparent; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; animation: flotar 5s ease-in-out infinite;
        }
        @keyframes flotar { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .faccion-sombra { filter: drop-shadow(0 8px 4px rgba(0,0,0,0.2)); }

        /* Cejas */
        .cejas-row { display: flex; gap: 140px; position: absolute; top: 30px; width: 100%; justify-content: center; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .ceja { width: 110px; height: 28px; background: white; border-radius: 30px; transition: 0.3s; }

        /* Ojos */
        .ojos-row { display: flex; gap: 60px; margin-top: 60px; z-index: 2; }
        .ojo-wrapper {
            width: 150px; height: 150px; /* Ojos grandes */
            position: relative; overflow: hidden; border-radius: 50%;
            background: white; border: 6px solid rgba(0,0,0,0.05); transition: 0.3s;
        }
        .pupila { 
            width: 70px; height: 70px; background: #222; border-radius: 50%; 
            position: absolute; top: 26%; left: 26%; transition: 0.1s;
        }
        .brillo {
            width: 30px; height: 30px; background: white; border-radius: 50%;
            position: absolute; top: 25px; right: 30px; opacity: 0.9;
        }
        
        /* Boca */
        .boca { 
            width: 80px; height: 25px; background: white; border-radius: 30px; 
            margin-top: 70px; transition: 0.3s; 
        }

        /* --- EXPRESIONES FLUIDAS --- */
        
        /* Hablando (boca se mueve, cejas rebotan) */
        .hablando .boca { width: 100px; height: 70px; border-radius: 40% 40% 50% 50%; animation: hablarAnim 0.2s infinite alternate; }
        .hablando .ceja { animation: cejasHablando 0.5s infinite alternate; }
        @keyframes hablarAnim { from { height: 30px; transform: scaleY(0.8); } to { height: 70px; transform: scaleY(1); } }
        @keyframes cejasHablando { from { transform: translateY(0); } to { transform: translateY(-5px); } }

        /* Sospecha / Pensando (Una ceja arriba, ojos entrecerrados) */
        .sospecha .ceja:first-child { transform: rotate(15deg) translateY(10px); } /* Ceja baja */
        .sospecha .ceja:last-child { transform: rotate(-15deg) translateY(-20px); } /* Ceja sube */
        .sospecha .ojo-wrapper { height: 120px; border-radius: 40%; margin-top: 15px; } /* Ojos achinados */
        .sospecha .boca { width: 60px; transform: translateX(10px) rotate(-5deg); }

        /* Sorpresa (Ojos gigantes, boca O) */
        .sorpresa .ceja { transform: translateY(-50px) scaleX(1.1); }
        .sorpresa .ojo-wrapper { transform: scale(1.15); border-color: #ff006e; }
        .sorpresa .boca { width: 70px; height: 70px; border-radius: 50%; margin-top: 80px; }

        /* Feliz (Ojos contentos, sonrisa) */
        .feliz .ojo-wrapper { height: 80px; margin-top: 35px; border-radius: 10px 10px 100px 100px; } /* Ojos en U invertida */
        .feliz .boca { width: 110px; height: 50px; border-radius: 10px 10px 100px 100px; margin-top: 60px; }
        .feliz .ceja { transform: translateY(-10px); }

        /* Enamorado (Corazones) */
        .enamorado .ojo-wrapper { background: #ff006e; }
        .enamorado .pupila, .enamorado .brillo { opacity: 0; }
        .enamorado .ojo-wrapper::after { content:'üòç'; font-size:100px; position:absolute; top:20px; left:25px; animation: latido 0.8s infinite; }

        /* --- UI TEXTO --- */
        #texto-globo {
            background: white; color: #222; padding: 30px 40px;
            border-radius: 50px; font-size: 2rem; text-align: center; max-width: 90%;
            box-shadow: 0 15px 0 rgba(0,0,0,0.1); font-weight: bold; margin-bottom: 20px;
            min-height: 100px; display: flex; align-items: center; justify-content: center;
            border: 6px solid white; transform: scale(0.9); opacity: 0; transition: 0.4s;
            position: relative; z-index: 20;
        }
        #texto-globo.visible { transform: scale(1); opacity: 1; }
        #texto-globo.alerta { color: #ff006e; }

        /* --- BOTONES --- */
        #botones-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; width: 95%; z-index: 20; }
        .btn {
            padding: 25px 50px; font-size: 1.6rem; border: none; border-radius: 60px;
            cursor: pointer; font-family: 'Fredoka', sans-serif; font-weight: bold;
            transition: 0.1s; box-shadow: 0 10px 0 rgba(0,0,0,0.2); opacity: 0; transform: translateY(30px);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn.show { opacity: 1; transform: translateY(0); }
        .btn:active { transform: translateY(10px); box-shadow: 0 0 0; }
        .btn-a { background: white; color: #ff006e; }
        .btn-b { background: #3a86ff; color: white; }

        /* SENSOR */
        #sensor-area { display: none; flex-direction: column; align-items: center; margin-top: 10px; z-index: 20; }
        #fingerprint {
            font-size: 6rem; width: 160px; height: 160px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: 8px dashed white; display: flex;
            align-items: center; justify-content: center; cursor: pointer; animation: pulse 1.5s infinite;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #fingerprint.active { background: #fff; color:#ff006e; border-style: solid; animation: none; transform: scale(0.95); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: 0 0 0 30px rgba(255,255,255,0); } }

        /* MODAL */
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 5000; flex-direction:column; align-items:center; justify-content:center; }
        #polaroid { background: white; padding: 25px 25px 80px 25px; transform: rotate(-2deg); box-shadow: 0 0 80px rgba(255,0,110,0.6); text-align: center; max-width: 85%; border-radius: 10px; }
        #foto-result { width: 100%; max-width: 500px; border: 2px solid #eee; display: block; }
        #score-badge { position: absolute; top: -30px; right: -20px; background: #ffdd00; color: #000; font-size: 2.5rem; font-weight: bold; padding: 20px; border-radius: 50%; border: 5px solid black; transform: rotate(15deg); font-family: 'Bangers', cursive; }
        #frase-final { font-family: 'Fredoka', sans-serif; color: #ff006e; font-size: 2.2rem; margin-top: 25px; font-weight: bold; text-transform: uppercase; }

        #start-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg, #ff006e, #8338ec); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="emoji-layer"></div>

    <div id="start-screen">
        <h1 style="font-family: 'Bangers', cursive; font-size: 6rem; margin-bottom: 10px; text-shadow: 5px 5px 0px #000;">CUPIDO IMJU</h1>
        <h2 style="font-size: 2rem; margin-top: 0; opacity: 1;">ESCUINAPA üç§üö≤</h2>
        <p style="font-size: 1.5rem; margin-bottom: 40px;">Descubre tu suerte en el amor</p>
        <button class="btn btn-a show" id="btn-init" onclick="iniciarApp()" disabled>Iniciando Sistema...</button>
    </div>

    <div id="header-imju">
        <h1>IMJU ESCUINAPA</h1>
        <p>Juventud que Transforma</p>
    </div>

    <video id="webcam" autoplay playsinline muted></video>

    <div id="avatar-container">
        <div id="cabeza">
            <div class="cejas-row faccion-sombra"><div class="ceja"></div><div class="ceja"></div></div>
            <div class="ojos-row faccion-sombra">
                <div class="ojo-wrapper"><div class="pupila"></div><div class="brillo"></div></div>
                <div class="ojo-wrapper"><div class="pupila"></div><div class="brillo"></div></div>
            </div>
            <div class="boca faccion-sombra"></div>
        </div>
    </div>

    <div id="texto-globo">Esperando a la raza...</div>

    <div id="botones-container"></div>

    <div id="sensor-area">
        <div id="fingerprint" onmousedown="scanStart()" onmouseup="scanEnd()" ontouchstart="scanStart()" ontouchend="scanEnd()">üíñ</div>
        <p id="sensor-instruccion" style="font-weight:bold; margin-top:25px; font-size: 1.5rem; text-shadow: 0 2px 4px black;">MANT√âN PULSADO</p>
    </div>

    <div id="modal">
        <div id="polaroid">
            <div id="score-badge">100%</div>
            <img id="foto-result" src="">
            <h2 id="frase-final">Fierro Pariente</h2>
        </div>
        <div style="margin-top:30px; display:flex; gap:20px;">
            <button class="btn btn-b show" onclick="descargar()">GUARDAR FOTO</button>
            <button class="btn btn-a show" onclick="location.reload()">REINICIAR</button>
        </div>
    </div>

    <script>
        // --- VOZ REALISTA (Prosodia Artificial) ---
        let vozSeleccionada = null;
        
        // Intentamos buscar las mejores voces disponibles en el navegador
        window.speechSynthesis.onvoiceschanged = () => {
            const voces = window.speechSynthesis.getVoices();
            console.log("Voces disponibles:", voces.length);
            
            // Prioridad: 1. Google US Spanish (Android), 2. Microsoft Mexico, 3. Cualquier ES-MX
            vozSeleccionada = voces.find(v => v.name.includes('Google') && v.lang.includes('es')) || 
                              voces.find(v => v.name.includes('Mexico') || v.name.includes('Sabina') || v.name.includes('Raul')) ||
                              voces.find(v => v.lang === 'es-MX') || 
                              voces.find(v => v.lang.includes('es'));
        };

        // --- EMOJIS ESCUINAPA ---
        function crearEmojisFondo() {
            const emojis = ['üç§', 'üö≤', 'ü•≠', 'üå¥', '‚ù§Ô∏è', 'üåÆ', 'üåä'];
            const container = document.getElementById('emoji-layer');
            setInterval(() => {
                const el = document.createElement('div');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.className = 'emoji-float';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.animationDuration = (Math.random() * 5 + 8) + 's';
                container.appendChild(el);
                setTimeout(() => el.remove(), 11000);
            }, 800);
        }
        crearEmojisFondo();

        // --- BASE DE DATOS (Logica Pareja Corregida) ---
        const DB = {
            SOLO: {
                intro: [
                    "¬°Qu√© rollo! ¬øVienes solo? A toda madre, mejor solo que mal acompa√±ado.",
                    "¬°Epa! Te veo muy solito pariente. Vamos a ver qu√© dice tu suerte.",
                    "¬øSoltero? ¬°Fierro! Tienes m√°s tiempo para ir a Las Cabras."
                ],
                preguntas: [
                    { q: "¬øQu√© prefieres el fin de semana?", a: "Malec√≥n y relax üåä", b: "Cenar tacos dorados üåÆ", rA: "¬°Puro relax, eso es todo!", rB: "¬°Uff, provecho pariente!" },
                    { q: "¬øQu√© buscas en una pareja?", a: "Que sea leal ü§ù", b: "Que me haga re√≠r üòÇ", rA: "La lealtad es primero.", rB: "La risa enamora, dicen." },
                    { q: "¬øBicicleta o Moto?", a: "Pura Bici üö≤", b: "Moto üèçÔ∏è", rA: "¬°Puro deporte local!", rB: "Con cuidado en esas calles." }
                ],
                resultados: [
                    { t: "Soltero de Oro", s: "100%", d: "Brillas m√°s que el sol de Teacap√°n." },
                    { t: "Rom√°ntico", s: "85%", d: "El amor ya viene en camino." },
                    { t: "Libre y Feliz", s: "99%", d: "Disfruta tu libertad, pariente." }
                ]
            },
            PAREJA: {
                intro: [
                    "¬°Pareja a la vista! Ojo: Que conteste solo uno de ustedes, p√≥nganse de acuerdo.",
                    "Se ven bien juntos. Pero solo uno pique los botones, no se peleen.",
                    "A ver si es amor del bueno. Elijan qui√©n va a responder por los dos."
                ],
                preguntas: [
                    { q: "¬øQui√©n de ustedes invita la cena?", a: "√âl/Ella siempre üí∏", b: "Vamos micha y micha", rA: "¬°Qu√© buen partido te conseguiste!", rB: "Justos, as√≠ me gusta." },
                    { q: "¬øQui√©n se enoja m√°s r√°pido?", a: "√âl/Ella üò°", b: "Yo mero üòí", rA: "Paciencia pariente, paciencia.", rB: "B√°jale dos rayitas al drama." },
                    { q: "¬øQui√©n maneja mejor la bici?", a: "√âl/Ella es pro üö≤", b: "Yo soy mejor", rA: "¬°Puro talento de Escuinapa!", rB: "Hagan carreritas pues." },
                    { q: "¬øQui√©n es m√°s probable que olvide el aniversario?", a: "√âl/Ella üìÖ", b: "Yo, tengo mala memoria", rA: "¬°P√≥nganle alarma al cel!", rB: "¬°Ay dolor! Te va a tocar castigo." }
                ],
                resultados: [
                    { t: "Amor del Bueno", s: "100%", d: "Se ven bien enamorados, ¬°Felicidades!" },
                    { t: "Pareja Dispareja", s: "60%", d: "Uno jala m√°s que el otro, aguas." },
                    { t: "Jalos al 100", s: "95%", d: "Son el uno para el otro, ¬°Fierro!" }
                ]
            },
            AMIGOS: {
                intro: [
                    "¬°Puro compa aqu√≠! Ojo: Uno responde, el otro apoya.",
                    "La clika de Escuinapa. Decidan qui√©n va a picarle a la pantalla.",
                    "A ver qui√©n es el l√≠der. Solo uno responde por el equipo."
                ],
                preguntas: [
                    { q: "¬øQui√©n baila mejor en las fiestas?", a: "Mi compa üíÉ", b: "Yo, obvio", rA: "¬°A sacar los pasos prohibidos!", rB: "El alma de la fiesta." },
                    { q: "¬øQui√©n le debe dinero a qui√©n?", a: "Yo le debo üôà", b: "Me debe feria üò†", rA: "P√°gale los 20 pesos, no seas as√≠.", rB: "C√≥brale con intereses." },
                    { q: "¬øQui√©n llega tarde siempre?", a: "Mi compa üê¢", b: "Yo, la neta", rA: "Reg√°lale un reloj, pariente.", rB: "La puntualidad es cortes√≠a de reyes." }
                ],
                resultados: [
                    { t: "Compas de Acero", s: "100%", d: "Amistad chingona, a prueba de todo." },
                    { t: "El D√∫o Din√°mico", s: "90%", d: "Juntos hacen puro desorden sano." },
                    { t: "Hermanos", s: "99%", d: "Sangre por sangre plebes." }
                ]
            }
        };

        // VARIABLES
        let model, video, trackingReq;
        let currentMode = null, questionQueue = [], qIndex = 0, isSpeaking = false;
        const textBubble = document.getElementById('texto-globo');
        const btnContainer = document.getElementById('botones-container');
        const sensorInstruccion = document.getElementById('sensor-instruccion');

        // INICIO
        async function setup() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video = document.getElementById('webcam');
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                model = await blazeface.load();
                document.getElementById('btn-init').innerText = "¬°DALE GAS!";
                document.getElementById('btn-init').disabled = false;
            } catch(e) { alert("Activa la c√°mara pariente, es necesario."); }
        }
        setup();

        function iniciarApp() {
            document.getElementById('start-screen').style.display = 'none';
            loopOjos(); 
            setEmocion('sospecha'); // Cara interesante al inicio
            hablar("¬°Qu√© rollo plebes! Soy el Cupido del I.M.J.U. Escuinapa. Vengo a leer sus vibras.", () => {
                setTimeout(preguntarModo, 1000);
            });
        }

        // JUEGO
        function preguntarModo() {
            setEmocion('sorpresa');
            mostrarTexto("¬øQui√©n anda ah√≠?");
            mostrarBotones([
                { txt: "Ando Solo/a ü§†", val: "SOLO" },
                { txt: "Somos Pareja ‚ù§Ô∏è", val: "PAREJA" },
                { txt: "Pura Raza ‚úåÔ∏è", val: "AMIGOS" }
            ]);
        }

        function handleSeleccion(val) {
            if (["SOLO", "PAREJA", "AMIGOS"].includes(val)) {
                currentMode = val;
                prepararJuego();
            } else if (val === "A" || val === "B") handleRespuesta(val);
        }

        function prepararJuego() {
            const data = DB[currentMode];
            questionQueue = [...data.preguntas].sort(() => 0.5 - Math.random()).slice(0, 3);
            qIndex = 0;
            const introRandom = data.intro[Math.floor(Math.random() * data.intro.length)];
            setEmocion('hablando');
            hablar(introRandom, siguientePregunta);
        }

        function siguientePregunta() {
            if (qIndex >= questionQueue.length) { faseSensor(); return; }
            const q = questionQueue[qIndex];
            setEmocion('sospecha'); // Cara de an√°lisis
            setTimeout(() => {
                setEmocion('normal'); // Cara normal
                mostrarTexto(q.q);
                hablar(q.q, () => { 
                    setTimeout(() => {
                        mostrarBotones([{ txt: q.a, val: "A" }, { txt: q.b, val: "B" }]);
                    }, 800);
                });
            }, 1000);
        }

        function handleRespuesta(opcion) {
            const q = questionQueue[qIndex];
            const reaccion = opcion === "A" ? q.rA : q.rB;
            // Expresiones fluidas
            if (reaccion.includes("!")) setEmocion('sorpresa'); 
            else if (reaccion.includes("amor") || reaccion.includes("bonito")) setEmocion('feliz');
            else setEmocion('hablando');
            
            mostrarTexto(reaccion);
            hablar(reaccion, () => {
                qIndex++;
                siguientePregunta();
            });
        }

        // SENSOR
        function faseSensor() {
            setEmocion('sospecha');
            const txt = currentMode === "SOLO" ? "Pon tu dedo y no lo sueltes." : "Pongan los dedos juntos y mantengan presionado.";
            mostrarTexto("¬°Hora de la verdad!");
            hablar(txt, () => {
                btnContainer.innerHTML = "";
                document.getElementById('sensor-area').style.display = 'flex';
            });
        }

        let sensorTimer;
        let sensorCompleto = false;

        function scanStart() {
            if(sensorCompleto) return;
            const f = document.getElementById('fingerprint');
            f.classList.add('active');
            
            sensorInstruccion.innerText = "¬°NO SUELTES!";
            sensorInstruccion.style.color = "#ffbe0b";
            mostrarTexto("LEYENDO VIBRAS...");
            playSonido(200, 400, 0.5);

            sensorTimer = setTimeout(() => {
                sensorCompleto = true;
                exitoSensor();
            }, 3000);
        }

        function scanEnd() {
            if(sensorCompleto) return;
            const f = document.getElementById('fingerprint');
            f.classList.remove('active');
            clearTimeout(sensorTimer);
            
            sensorInstruccion.innerText = "¬°TE DIJE QUE NO SOLTARAS!";
            sensorInstruccion.style.color = "white";
            textBubble.classList.add('alerta');
            mostrarTexto("¬°Ey! ¬°Sin miedo! D√©jalo puesto.");
            playSonido(150, 100, 0.3);
            setEmocion('sospecha'); // Cara de rega√±o
            
            setTimeout(() => {
                textBubble.classList.remove('alerta');
                sensorInstruccion.innerText = "INTENTA OTRA VEZ";
            }, 1500);
        }

        function exitoSensor() {
            document.getElementById('sensor-area').style.display = 'none';
            setEmocion('enamorado');
            playSonido(600, 1200, 1.0);
            
            const resultadosPosibles = DB[currentMode].resultados;
            const res = resultadosPosibles[Math.floor(Math.random() * resultadosPosibles.length)];
            
            mostrarTexto("¬°AN√ÅLISIS COMPLETO!");
            hablar(`¬°Fierro! Ustedes son: ${res.t}. ${res.d}. ¬°Acom√≥dense pa' la foto!`, () => {
                setTimeout(() => cuentaRegresivaFoto(res), 1500);
            });
        }

        function cuentaRegresivaFoto(resFinal) {
            setEmocion('feliz');
            cancelAnimationFrame(trackingReq); 
            
            let count = 3;
            textBubble.classList.add('alerta'); 

            const interval = setInterval(() => {
                 if(count > 0) {
                     mostrarTexto(count);
                     playSonido(800, 800, 0.1);
                     count--;
                 } else {
                     clearInterval(interval);
                     mostrarTexto("¬°SONR√çAN! üì∏");
                     playSonido(1000, 1200, 0.3);
                     setTimeout(() => tomarFoto(resFinal), 500);
                 }
            }, 1000);
        }

        function tomarFoto(res) {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            
            document.getElementById('foto-result').src = canvas.toDataURL('image/jpeg');
            document.getElementById('score-badge').innerText = res.s;
            document.getElementById('frase-final').innerText = res.t;
            document.getElementById('modal').style.display = 'flex';
        }

        // UTILS
        async function loopOjos() {
            const preds = await model.estimateFaces(video, false);
            if (preds.length > 0) {
                const p = preds[0];
                const x = (p.topLeft[0] + p.bottomRight[0]) / 2;
                const y = (p.topLeft[1] + p.bottomRight[1]) / 2;
                // Movimiento muy suave
                const xEye = (x / video.videoWidth - 0.5) * 60; 
                const yEye = (y / video.videoHeight - 0.5) * 50;
                document.querySelectorAll('.pupila').forEach(pup => {
                    pup.style.transform = `translate(${xEye}px, ${yEye}px)`;
                });
            }
            trackingReq = requestAnimationFrame(loopOjos);
        }

        function setEmocion(emo) {
            const cabeza = document.getElementById('cabeza');
            cabeza.className = ""; 
            if (emo !== 'normal') cabeza.classList.add(emo);
        }

        function hablar(texto, callback) {
            window.speechSynthesis.cancel();
            isSpeaking = true;
            const u = new SpeechSynthesisUtterance(texto);
            if (vozSeleccionada) u.voice = vozSeleccionada;
            u.lang = "es-MX";
            
            // "Prosodia Artificial" (Cambia tono seg√∫n puntuaci√≥n para sonar real)
            if (texto.includes("!")) { 
                u.rate = 1.1; u.pitch = 1.2; // Exclamaci√≥n: R√°pido y agudo
            } else if (texto.includes("?")) { 
                u.rate = 1.0; u.pitch = 1.1; // Pregunta: Tono sube al final
            } else if (texto.includes("...")) {
                u.rate = 0.9; u.pitch = 0.9; // Suspenso: Lento y grave
            } else { 
                u.rate = 1.0; u.pitch = 1.0; // Normal
            }

            u.onstart = () => document.getElementById('cabeza').classList.add('hablando');
            u.onend = () => {
                document.getElementById('cabeza').classList.remove('hablando');
                isSpeaking = false;
                if(callback) callback();
            };
            window.speechSynthesis.speak(u);
        }

        function mostrarTexto(txt) {
            textBubble.innerText = txt;
            textBubble.classList.add('visible');
        }

        function mostrarBotones(lista) {
            btnContainer.innerHTML = "";
            lista.forEach((item, i) => {
                const btn = document.createElement('button');
                btn.className = i === 0 ? "btn btn-a" : "btn btn-b";
                btn.innerText = item.txt;
                btn.onclick = () => { btnContainer.innerHTML = ""; handleSeleccion(item.val); };
                btnContainer.appendChild(btn);
                setTimeout(() => btn.classList.add('show'), i * 150);
            });
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSonido(f1, f2, duracion = 0.5) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(f1, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(f2, audioCtx.currentTime + duracion);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duracion);
            osc.start(); osc.stop(audioCtx.currentTime + duracion);
        }

        function descargar() {
            const a = document.createElement('a');
            a.href = document.getElementById('foto-result').src;
            a.download = "CupidoIMJUEscuinapa.jpg";
            a.click();
        }
    </script>
</body>
</html>
